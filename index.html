<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LP/ALP Duty Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    select, input[type="date"] { padding: 5px; margin-bottom: 10px; }
    .rest { background-color: #ffe0e0; }
    #dateHeading { font-size: 18px; margin-bottom: 10px; font-weight: bold; }
    .controls { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h2>LP/ALP Duty Viewer</h2>
  <div id="dateHeading"></div>

  <div class="controls">
    <label for="daySelect">Select Day: </label>
    <select id="daySelect">
      <option>Sunday</option>
      <option>Monday</option>
      <option>Tuesday</option>
      <option>Wednesday</option>
      <option>Thursday</option>
      <option>Friday</option>
      <option>Saturday</option>
    </select>

    &nbsp;&nbsp;

    <label for="datePicker">Select Date: </label>
    <input type="date" id="datePicker" />
  </div>

  <table>
    <thead>
      <tr>
        <th>LP ID</th>
        <th>ALP ID</th>
        <th>Train No (Outgoing/Incoming)</th>
        <th>Dep Time</th>
        <th>Link Number</th>
      </tr>
    </thead>
    <tbody id="dutyTable"></tbody>
  </table>

  <script>
    const daySelect = document.getElementById('daySelect');
    const datePicker = document.getElementById('datePicker');
    const daysArray = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    let crewData = [];
    let linkNumber = 1;
    let lastUpdatedDate;
    let currentCrewIndex = 0;

    // Initialize controls to today
    function initializeControls() {
      const today = new Date();
      datePicker.valueAsDate = today;
      daySelect.value = today.toLocaleString('en-US', { weekday: 'long' });
    }

    // Rotate array by n positions
    function rotateArray(arr, n) {
      return arr.slice(n).concat(arr.slice(0, n));
    }

    function getSelectedDate() {
      const dateInput = datePicker.value;
      return dateInput ? new Date(dateInput) : new Date();
    }

    function updateDateHeading(date) {
      const formattedDate = date.toLocaleDateString('en-GB', {
        day: '2-digit', month: 'short', year: 'numeric'
      });
      const dayName = date.toLocaleString('en-US', { weekday: 'long' });
      document.getElementById('dateHeading').textContent = `${dayName}, ${formattedDate}`;
    }

    function syncDatePickerToDay() {
      const selectedDay = daySelect.value;
      const today = new Date();
      const todayIndex = today.getDay();
      const targetIndex = daysArray.indexOf(selectedDay);
      let dayDiff = targetIndex - todayIndex;
      if (dayDiff < 0) dayDiff += 7;
      const targetDate = new Date();
      targetDate.setDate(today.getDate() + dayDiff);
      datePicker.valueAsDate = targetDate;
    }

    function syncDaySelectToDate() {
      const selectedDate = getSelectedDate();
      const dayName = selectedDate.toLocaleString('en-US', { weekday: 'long' });
      daySelect.value = dayName;
    }

    function renderTable() {
      if (!crewData.length) return;

      const selectedDate = getSelectedDate();
      const selectedDay = daySelect.value;

      // Calculate weeks passed from lastUpdatedDate to selectedDate
      const diffMs = selectedDate.getTime() - lastUpdatedDate.getTime();
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const weeksPassed = Math.floor(diffDays / 7);

      // Calculate rotated crew start index for this date's week
      const startIndex = (currentCrewIndex + weeksPassed) % crewData.length;

      // Rotate crew array accordingly for this week
      const rotatedCrew = rotateArray(crewData, startIndex);

      // Sort by depTime ascending, REST last
      rotatedCrew.sort((a, b) => {
        const dutyA = a.duties[selectedDay];
        const dutyB = b.duties[selectedDay];

        if (dutyA === 'REST' && dutyB !== 'REST') return 1;
        if (dutyB === 'REST' && dutyA !== 'REST') return -1;
        if (!dutyA) return 1;
        if (!dutyB) return -1;

        const timeA = dutyA.depTime || null;
        const timeB = dutyB.depTime || null;

        if (!timeA) return 1;
        if (!timeB) return -1;

        const [hA, mA] = timeA.split(':').map(Number);
        const [hB, mB] = timeB.split(':').map(Number);

        return (hA * 60 + mA) - (hB * 60 + mB);
      });

      updateDateHeading(selectedDate);

      const tbody = document.getElementById('dutyTable');
      tbody.innerHTML = '';

      rotatedCrew.forEach(c => {
        const duty = c.duties[selectedDay] || '';
        let trainNo = '';
        let depTime = '';

        if (typeof duty === 'object' && duty.outgoing) {
          trainNo = `${duty.outgoing}/${duty.incoming || ''}`;
          depTime = duty.depTime || '';
        } else if (typeof duty === 'string') {
          trainNo = duty.toUpperCase() === 'REST' ? 'REST' : duty;
        }

        const row = document.createElement('tr');
        if (trainNo === 'REST') row.classList.add('rest');

        row.innerHTML = `
          <td>${c.crewLPId}</td>
          <td>${c.crewALPId}</td>
          <td>${trainNo}</td>
          <td>${depTime}</td>
          <td>${linkNumber}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Event listeners
    daySelect.addEventListener('change', () => {
      syncDatePickerToDay();
      renderTable();
    });

    datePicker.addEventListener('change', () => {
      syncDaySelectToDate();
      renderTable();
    });

    // Load JSON data
    fetch('link1.json')
      .then(response => {
        if (!response.ok) throw new Error("Failed to load JSON");
        return response.json();
      })
      .then(data => {
        crewData = data.crew || [];
        linkNumber = data.linkId || 1;
        lastUpdatedDate = new Date(data.lastUpdated);
        currentCrewIndex = data.currentCrewIndex || 0;

        initializeControls();
        renderTable();
      })
      .catch(err => {
        console.error("Error loading JSON:", err);
        alert("Could not load crew data.");
      });
  </script>
</body>
</html>
