<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Test — Duty Table</title>
<style>
:root{--bg:#f4f7fb;--card:#fff;--muted:#6b7280;--accent:#0f172a;--train-col-width:110px;--row-height:58px;--pill-space:34px}
body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--accent)}
.wrap{max-width:1100px;margin:14px auto;padding:6px}
.card{background:#fff;padding:8px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.06)}
.tableWrap{overflow:auto}
table{width:100%;border-collapse:collapse}
thead th, tbody td{border:1px solid #e0e6ef;padding:8px;text-align:center;height:var(--row-height)}
.link-pill{position:relative;display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(0,0,0,0.06);font-weight:700;background:transparent;color:#666}
.train-number{font-weight:700;max-width:calc(var(--train-col-width) - 12px);display:inline-block}
.ownerTag{margin-left:6px;background:#2563eb;color:#fff;padding:3px 6px;border-radius:6px;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>LP/ALP Duty Table — Test</h3>
      <div class="tableWrap">
        <table id="mainTable" aria-describedby="dateHeading">
          <thead>
            <tr><th>LP</th><th>ALP</th><th>Train No</th><th>Dep</th><th>Link No</th></tr>
          </thead>
          <tbody id="dutyTable"><tr><td colspan="5">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* Sample inline link data (instead of fetching) */
const sampleFiles = [
  { file: 'link1.json', linkId: 'link1', crew: [{ duties: { Monday: { outgoing: 'sp/10107/', depTime:'06:20' } }, name:'Crew A' }] },
  { file: 'rnlink1.json', linkId: 'rnlink1', crew: [{ duties: { Monday: { outgoing: '12345', depTime:'07:05' } }, name:'Crew B' }] },
  { file: 'sllink1.json', linkId: 'sllink1', crew: [{ duties: { Monday: { outgoing: 'sp/8888', depTime:'08:00' } }, name:'Crew C' }] },
  { file: 'ollink1.json', linkId: 'ollink1', crew: [{ duties: { Monday: { outgoing: '67890', depTime:'09:10' } }, name:'Crew D' }] }
];

let allCrewData = [];
const dutyTable = document.getElementById('dutyTable');

function getShortLinkLabel(linkId){
  if(!linkId) return '';
  const id = String(linkId).toLowerCase().trim();
  let m = id.match(/^link(\d+)$/); if(m) return `MAO${m[1]}`;
  m = id.match(/^rnlink(\d+)$/); if(m) return `RN${m[1]}`;
  m = id.match(/^sllink(\d+)$/); if(m) return `SL${m[1]}`;
  m = id.match(/^ollink(\d+)$/); if(m) return `OL${m[1]}`;
  const digits = id.match(/(\d+)/); if(digits){ if(id.includes('rn')) return `RN${digits[1]}`; if(id.includes('ol')) return `OL${digits[1]}`; if(id.includes('sl')) return `SL${digits[1]}`; return `MAO${digits[1]}`;}
  return String(linkId).toUpperCase();
}

function formatTrainToken(token){
  if(!token) return '';
  const s = String(token).trim();
  if(/^\d{5}$/.test(s)) return `<span class="train-number">${s}</span>`;
  if(s.includes('/') && s.length <= 12) return `<span class="train-number">${s}</span>`;
  return `<span class="train-number">${s.replace(/\//g,'/<wbr>')}</span>`;
}

function loadInline(){
  allCrewData = [];
  sampleFiles.forEach((f, idx)=>{
    const linkId = f.linkId || String(f.file).replace(/\.json$/,'');
    const crew = Array.isArray(f.crew) ? f.crew : [];
    crew.forEach((c,i)=> allCrewData.push({ ...c, linkId, crewIndex:i }));
  });
  render();
}

function render(){
  if(!allCrewData.length){ dutyTable.innerHTML = '<tr><td colspan="5">No data</td></tr>'; return; }
  dutyTable.innerHTML = '';
  allCrewData.forEach(item=>{
    const day = (new Date()).toLocaleString('en-US',{weekday:'long'});
    const wk = item.duties && item.duties[day] ? item.duties[day] : (item.duties && item.duties.Monday ? item.duties.Monday : null);
    const out = wk && wk.outgoing ? wk.outgoing : '';
    const dep = wk && wk.depTime ? wk.depTime : '';
    const tr = document.createElement('tr');
    const linkLabel = getShortLinkLabel(item.linkId);
    tr.innerHTML = `<td>${item.name || '—'}</td><td>—</td><td>${formatTrainToken(out)}</td><td>${dep}</td><td><span class="link-pill">${linkLabel}</span></td>`;
    dutyTable.appendChild(tr);
  });
  console.log('Rendered rows:', allCrewData.length);
}

loadInline();
</script>
</body>
</html>
