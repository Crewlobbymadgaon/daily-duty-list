<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LP/ALP Duty List â€” Madgaon Lobby (Firebase)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f7fb;
  --card:#fff;
  --muted:#6b7280;
  --accent:#0f172a;
  --accent-2:#2563eb;
  --radius:12px;
  --divider:#1f6feb;
  --border:#cdd4e1;

  /* pill outline colors (light) */
  --pill-outline-link: rgba(37,99,235,0.14);  /* light blue border */
  --pill-outline-dep: rgba(15,23,42,0.08);    /* light dark border */
  --pill-text-link: rgba(37,99,235,0.92);
  --pill-text-dep: rgba(15,23,42,0.9);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--accent);-webkit-font-smoothing:antialiased}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 24px rgba(15,23,42,0.06);overflow:hidden}
.headerArea{position:sticky; top:0;background:var(--card);padding:14px 16px;border-bottom:1px solid rgba(0,0,0,0.04);z-index:60;display:flex;flex-direction:column;align-items:center;gap:6px;}
.headerArea h1{margin:0;font-size:1.25rem;font-weight:700;text-align:center}
.headerArea .sub{font-size:0.9rem;color:var(--muted);text-align:center}
.headerArea #dateHeading{font-weight:600;color:var(--accent-2);text-align:center}
.headerArea #loginStatus{font-size:0.78rem;color:var(--muted);margin-top:6px}
.headerArea #notice{font-size:0.78rem;color:#6b7280;margin-top:4px;display:none}
.controls{position:sticky;top:0;background:var(--card);z-index:55;display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;border-bottom:1px solid rgba(0,0,0,0.03)}
.nav-btn{background:transparent;border:1px solid rgba(15,23,42,0.06);width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.date-icon-btn{display:inline-flex;align-items:center;justify-content:center;background:var(--accent-2);color:#fff;border:none;border-radius:8px;min-width:44px;height:36px;padding:0 10px;cursor:pointer}
input[type="date"].native-date{position:absolute;left:-9999px}
.tableWrap{max-height:calc(100vh - 112px);overflow:auto;border-radius:0;background:#fff;padding:6px;position:relative}
table{width:100%;border-collapse:collapse;min-width:640px;table-layout:fixed;border:1px solid var(--border)}
thead th{background:var(--card);padding:10px 12px;text-align:center;color:var(--muted);font-weight:700;border-bottom:1px solid var(--border);border-top:1px solid rgba(0,0,0,0.04);position:sticky;z-index:70;top:0;box-sizing:border-box}
tbody td{padding:10px 12px;border:1px solid var(--border);font-size:0.95rem;color:var(--accent);vertical-align:middle;text-align:center;overflow:visible;word-break:break-word;overflow-wrap:anywhere}
tbody tr:nth-child(odd){background:#fbfdff}
.no-data{text-align:center;color:var(--muted);padding:14px}

/* default column sizes */
thead th:nth-child(1), td:nth-child(1){width:36%}
thead th:nth-child(2), td:nth-child(2){width:36%}
thead th:nth-child(3), td:nth-child(3){width:18%}
thead th:nth-child(4), td:nth-child(4){width:5%}
thead th:nth-child(5), td:nth-child(5){width:5%}

.cell-center{display:flex;align-items:center;justify-content:center;min-height:44px}

/* TRAIN STACK - reserve enough top space so pills never overlap content.
   We make this fairly large and consistent to avoid device quirks. */
.train-stack{
  display:inline-flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  padding:8px 6px;
  max-width:100%;
  box-sizing:border-box;
  position:relative;
  padding-top:48px; /* IMPORTANT: reserve space for top-left/top-right pills */
  min-height:72px;
}

/* TOP-LEFT LINK PILL: outline-only, light border, uppercase label (from JSON if present) */
.train-linklabel{
  position:absolute;
  top:6px;
  left:6px;
  font-size:0.72rem;
  color:var(--pill-text-link);
  background:transparent;
  border:1px solid var(--pill-outline-link);
  padding:4px 8px;
  border-radius:999px;
  text-transform:uppercase;
  letter-spacing:0.3px;
  font-weight:700;
  line-height:1;
  pointer-events:none;
  z-index:110;
}

/* TOP-RIGHT DEP TIME PILL: outline-only, light border */
.train-deptime{
  position:absolute;
  top:6px;
  right:6px;
  font-size:0.72rem;
  color:var(--pill-text-dep);
  background:transparent;
  border:1px solid var(--pill-outline-dep);
  padding:4px 8px;
  border-radius:999px;
  line-height:1;
  pointer-events:none;
  font-weight:700;
  z-index:110;
}

/* ensure content lines have no extra top margins */
.train-top, .train-bottom, .train-number { margin:0; padding:0; }

/* train number style */
.train-number{
  white-space:nowrap;
  font-weight:700;
  display:inline-block;
  font-size:0.88rem;
  line-height:1;
}

.train-top,.train-bottom{
  font-weight:400;
  font-size:0.90rem;
  line-height:1;
  display:inline-block;
  text-align:center;
  white-space:normal;
  overflow-wrap:anywhere;
  word-break:break-word;
  max-width:100%;
}

/* divider */
.train-divider{ width:90%; height:2px; background:var(--divider); border-radius:2px; margin:0; }
.nowrap{ white-space:nowrap; display:inline-block; }

/* MOBILE adjustments */
@media (min-width:900px){ .train-divider{ width:100%; max-width:180px } }
@media (max-width:640px){
  table{min-width:0;table-layout:auto}
  /* hide Dep & Link columns visually (we show pills inside train cell) */
  thead th:nth-child(4),thead th:nth-child(5),tbody td:nth-child(4),tbody td:nth-child(5){display:none}

  /* mobile column sizing: LP 40%, Train 25%, ALP 35% */
  thead th:nth-child(1), td:nth-child(1){width:40% !important; text-align:left; padding-left:10px}
  thead th:nth-child(2), td:nth-child(2){width:25% !important; white-space:nowrap; font-weight:700}
  thead th:nth-child(3), td:nth-child(3){width:35% !important; text-align:right; padding-right:10px}

  thead th,tbody td{padding:8px}
  .train-top,.train-bottom{font-size:0.86rem}
  .train-divider{height:1.5px; width:85%}
  .cell-center{min-height:36px}
  .editable{padding:4px 6px;min-height:28px}

  .train-number{font-size:0.86rem}
  .train-stack{padding-top:44px; min-height:56px}
  .train-deptime{top:4px; right:6px; font-size:0.68rem}
  .train-linklabel{top:4px; left:6px; font-size:0.68rem}
}

/* Make LP/ALP names bold */
.editable{
  display:block;
  min-height:32px;
  padding:6px;
  border-radius:6px;
  outline:none;
  cursor:text;
  width:100%;
  box-sizing:border-box;
  user-select:text;
  text-align:center;
  font-weight:700;
}
.editable:focus{box-shadow:0 0 0 3px rgba(37,99,235,0.08);border:1px dashed rgba(37,99,235,0.15)}
.editable[contenteditable="false"]{background:transparent;cursor:not-allowed;color:rgba(0,0,0,0.6)}
#adminSignInBtn{position:fixed;top:10px;right:10px;z-index:120;background:#111;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
.toast{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .18s}
.toast.show{opacity:1;transform:translateY(0)}
.ownerTag{font-size:0.7rem;color:#fff;background:#2563eb;padding:4px 6px;border-radius:6px;display:inline-block;margin-left:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="headerArea" role="banner" aria-label="Header">
        <h1>LP/ALP Duty List</h1>
        <div class="sub">Madgaon Lobby</div>
        <div id="dateHeading">Loading dateâ€¦</div>
        <div id="loginStatus" aria-live="polite"></div>
        <div id="notice"> <!-- intentionally hidden --> </div>
      </div>

      <div class="controls" role="toolbar" aria-label="Date controls">
        <button id="prevDay" class="nav-btn" title="Previous day">â—€</button>
        <button id="dateBtn" class="date-icon-btn" title="Pick a date">ðŸ“…</button>
        <input id="datePicker" class="native-date" type="date" />
        <button id="nextDay" class="nav-btn" title="Next day">â–¶</button>
      </div>

      <div class="tableWrap" aria-live="polite">
        <table id="mainTable" aria-describedby="dateHeading">
          <thead>
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="dutyTable">
            <tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <button id="adminSignInBtn" title="Admin sign-in">Admin</button>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* FIREBASE CONFIG (your provided config) */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyA39vWi_90CUyj0davz4XAXqMey1aNM6FU",
  authDomain: "crewdutytable.firebaseapp.com",
  databaseURL: "https://crewdutytable-default-rtdb.firebaseio.com",
  projectId: "crewdutytable",
  storageBucket: "crewdutytable.firebasestorage.app",
  messagingSenderId: "190634478615",
  appId: "1:190634478615:web:28e998325f69fb8bf36052"
};

/* link files & storage key */
const linkFiles = [
  'link1.json','link2.json','link3.json','link4.json',
  'rnlink1.json','rnlink2.json','rnlink3.json',
  'ollink1.json','sllink1.json'
];
const LS_KEY = 'lp_alp_edits_owner_v1';

/* state */
let localEdits = loadLocalEdits();
let allCrewData = [];
let selectedDate = new Date();
let firebaseApp = null, firebaseAuth = null, firebaseDb = null;
let currentUser = null, isAdmin = false;

/* small UX state for editing preservation */
window.currentlyEditing = null;     // {link, crewIndex, field}
window._commitDebounce = null;      // to debounce blur commits

/* init firebase */
try {
  firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
  firebaseAuth = firebase.auth();
  firebaseDb = firebase.database();

  if (firebaseAuth && firebase.auth && firebase.auth.Auth && firebase.auth.Auth.Persistence) {
    firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
  }

  firebaseAuth.onAuthStateChanged(async (user) => {
    if (user){
      currentUser = {
        uid: user.uid,
        displayName: user.displayName || user.email || user.uid,
        email: user.email || null,
        anon: user.isAnonymous || false
      };
    } else {
      currentUser = loadLocalUser() || createLocalUser();
    }
    await detectAdmin();
    updateLoginStatusUI();
    await renderCombinedDuties();
  });
} catch(e){
  console.warn('Firebase init error', e);
  currentUser = loadLocalUser() || createLocalUser();
  updateLoginStatusUI();
}

/* DOM */
const dutyTable = document.getElementById('dutyTable');
const mainTable = document.getElementById('mainTable');
const tableWrap = document.querySelector('.tableWrap');
const dateBtn = document.getElementById('dateBtn');
const datePicker = document.getElementById('datePicker');
const prevBtn = document.getElementById('prevDay');
const nextBtn = document.getElementById('nextDay');
const dateHeading = document.getElementById('dateHeading');
const toast = document.getElementById('toast');
const adminSignInBtn = document.getElementById('adminSignInBtn');
const loginStatus = document.getElementById('loginStatus');
const notice = document.getElementById('notice');

/* helpers */
function showToast(msg, t=1600){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>toast.classList.remove('show'), t); }
function loadLocalEdits(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }catch(e){ return {}; } }
function saveLocalEdits(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(localEdits)); }catch(e){} }
function loadLocalUser(){ try{ return JSON.parse(localStorage.getItem('lp_user_v_owner')||'null'); }catch(e){return null} }
function saveLocalUser(u){ try{ localStorage.setItem('lp_user_v_owner',JSON.stringify(u)); }catch(e){} }
function createLocalUser(){ const uid = 'local-'+Math.random().toString(36).slice(2,9); const u = { uid, displayName: `Viewer-${uid.slice(-4)}`, local:true }; saveLocalUser(u); return u; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function placeCaretAtEnd(el){ try{ el.focus(); const range=document.createRange(); range.selectNodeContents(el); range.collapse(false); const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range);}catch(e){} }

/* mapping fallback: uppercase short labels like MAO1, RN1, OL1 */
function fallbackShortLinkLabel(linkId) {
  if (!linkId) return '';
  const id = String(linkId).toLowerCase();
  if (id.startsWith('link')) { const num = id.replace(/\D/g, ''); return `MAO${num}`; }
  if (id.startsWith('rnlink')) { const num = id.replace(/\D/g, ''); return `RN${num}`; }
  if (id.startsWith('ollink')) { const num = id.replace(/\D/g, ''); return `OL${num}`; }
  if (id.startsWith('sllink')) { const num = id.replace(/\D/g, ''); return `SL${num}`; }
  const digits = id.match(/\d+/);
  if(digits) return `L${digits[0]}`;
  return String(linkId).toUpperCase();
}
function formatTrainToken(token){ 
  if(!token) return ''; 
  const cleaned = token.toString().trim(); 
  if(/^\d{4,6}$/.test(cleaned)){ 
    return `<span class="train-number">${escapeHtml(cleaned)}</span>`; 
  } 
  return `<span class="train-number">${escapeHtml(cleaned)}</span>`.replace(/\//g,'<wbr>/'); 
}

/* layout helpers */
function setTableWrapPaddingAndHeader(){
  const header = document.querySelector('.headerArea');
  const controls = document.querySelector('.controls');
  if(!header || !controls || !tableWrap) return;
  const headerRect = header.getBoundingClientRect();
  const controlsRect = controls.getBoundingClientRect();
  const wrapRect = tableWrap.getBoundingClientRect();
  let numericTop = Math.round(controlsRect.bottom - wrapRect.top);
  numericTop = Math.max(0, numericTop);
  tableWrap.style.paddingTop = numericTop + 'px';
  tableWrap.style.boxSizing = 'border-box';
  document.querySelectorAll('thead th').forEach(th => { th.style.top = '0px'; });
  const reserved = Math.round(headerRect.height + controlsRect.height) + 28;
  tableWrap.style.maxHeight = Math.max(120, window.innerHeight - reserved) + 'px';
  alignHeaderWidths();
}
function alignHeaderWidths(){
  const thead = mainTable.querySelector('thead');
  if(!thead) return;
  const ths = Array.from(thead.querySelectorAll('th'));
  const firstRow = mainTable.querySelector('tbody tr');
  let widths = [];
  if(firstRow){
    const tds = Array.from(firstRow.querySelectorAll('td'));
    if(tds.length === ths.length){
      widths = tds.map(td => Math.round(td.getBoundingClientRect().width) || Math.round(ths[0].getBoundingClientRect().width));
    }
  }
  if(widths.length !== ths.length){
    widths = ths.map(th => Math.round(th.getBoundingClientRect().width) || 80);
  }
  ths.forEach((th,i)=>{ const w = widths[i] || 60; th.style.width = w+'px'; th.style.minWidth = w+'px'; th.style.maxWidth = w+'px'; th.style.boxSizing='border-box'; });
  const mainWidth = Math.round(mainTable.getBoundingClientRect().width);
  mainTable.style.tableLayout = 'fixed';
  mainTable.style.width = mainWidth + 'px';
}

/* Date controls */
dateBtn.addEventListener('click', ()=>{ datePicker.focus(); datePicker.click(); });
datePicker.addEventListener('change', ()=>{ selectedDate = datePicker.value ? new Date(datePicker.value+'T00:00:00') : new Date(); setSelectedDate(selectedDate); renderCombinedDuties(); });
prevBtn.addEventListener('click', ()=> changeDate(-1));
nextBtn.addEventListener('click', ()=> changeDate(1));
function changeDate(offset){ const d=new Date(selectedDate.getTime()); d.setDate(d.getDate()+offset); setSelectedDate(d); renderCombinedDuties(); }
function setSelectedDate(d){ selectedDate = d||new Date(); const yyyy=selectedDate.getFullYear(), mm=String(selectedDate.getMonth()+1).padStart(2,'0'), dd=String(selectedDate.getDate()).padStart(2,'0'); datePicker.value = `${yyyy}-${mm}-${dd}`; dateHeading.textContent = `${selectedDate.toLocaleString('en-US',{weekday:'long'})}, ${selectedDate.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`; }

/* Responsive header/row reorder helpers */
const MOBILE_Q = '(max-width: 640px)';
const mql = window.matchMedia(MOBILE_Q);
function isMobile() { return window.matchMedia(MOBILE_Q).matches; }
function theadRowEl(){ return document.getElementById('theadRow'); }
function renderTableHead(){
  const tr = theadRowEl();
  if(!tr) return;
  if(isMobile()){
    tr.innerHTML = `
      <th style="text-align:center">LP</th>
      <th style="text-align:center">Train No:</th>
      <th style="text-align:center">ALP</th>
      <th style="text-align:center">Dep</th>
      <th style="text-align:center">Link No</th>
    `;
  } else {
    tr.innerHTML = `
      <th style="text-align:center">LP</th>
      <th style="text-align:center">ALP</th>
      <th style="text-align:center">Train No:</th>
      <th style="text-align:center">Dep</th>
      <th style="text-align:center">Link No</th>
    `;
  }
}

/* Load JSON link files.
   When a JSON file contains a friendly name, prefer that: we check `label`, `linkName`, `displayName`, `name`. */
async function loadAllLinks(){
  dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>`;
  const fetches = linkFiles.map(async (f, idx) => {
    try {
      console.log('Fetching', f);
      const r = await fetch(f, {cache:'no-cache'});
      if (!r.ok){
        const text = await r.text().catch(()=>'<no body>');
        console.error(`Failed to fetch ${f}:`, r.status, r.statusText, text);
        return { __error:true, file:f, status:r.status, statusText:r.statusText, body:text };
      }
      const json = await r.json().catch(async (err)=>{
        const txt = await r.text().catch(()=>'<no body>');
        return { __error:true, file:f, parseErr: (err && err.message), body: txt };
      });
      return json;
    } catch(err){
      console.error('Fetch error', f, err);
      return { __error:true, file:f, err: (err && err.message) };
    }
  });

  const results = await Promise.all(fetches);
  allCrewData = [];
  const anySuccess = results.some(r => r && !r.__error);
  if(!anySuccess){
    dutyTable.innerHTML = '';
    results.forEach(res=>{
      const msg = res && res.__error ? `${res.file} â€” ${res.status||''} ${res.parseErr||res.err||''}` : 'Unknown error';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5" class="no-data">Failed to load: ${escapeHtml(msg)}</td>`;
      dutyTable.appendChild(tr);
    });
    setTableWrapPaddingAndHeader();
    return;
  }

  results.forEach((linkData, idx) => {
    if(!linkData || linkData.__error) return;
    const linkId = linkData.linkId ?? (`file#${idx+1}`);
    const lastUpdated = linkData.lastUpdated ? new Date(linkData.lastUpdated) : new Date();
    const crewArr = Array.isArray(linkData.crew) ? linkData.crew : [];

    // try to extract a friendly link label from the JSON file (user requested)
    const possibleLabel = (linkData && (linkData.label || linkData.linkName || linkData.displayName || linkData.name)) || null;
    // if present, use it; otherwise fall back to the old mapping
    const friendlyLabel = possibleLabel ? String(possibleLabel).trim() : null;

    crewArr.forEach((crew, crewIndex) => allCrewData.push({
      ...crew,
      linkId,
      lastUpdatedDate: lastUpdated,
      crewIndex,
      linkLabel: friendlyLabel  // may be null; renderer will fallback if null
    }));
  });

  await renderCombinedDuties();
}

/* Render + ownership: only admin may edit (client-side); employees view only. */
async function renderCombinedDuties(){
  renderTableHead();
  const editingInfo = window.currentlyEditing ? {...window.currentlyEditing} : null;

  if(!allCrewData.length){ dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No data available</td></tr>`; setTableWrapPaddingAndHeader(); return; }
  const weekday = selectedDate.toLocaleString('en-US',{weekday:'long'});

  let fbEdits = {};
  if(firebaseDb){
    try{ const snap = await firebaseDb.ref('/edits').once('value'); fbEdits = snap.val() || {}; }catch(e){ fbEdits = {}; console.warn('fbEdits load failed', e); }
  }

  const crewsByLink = allCrewData.reduce((acc,crew)=>{ (acc[crew.linkId]=acc[crew.linkId]||[]).push(crew); return acc; }, {});
  const rows = [];

  Object.values(crewsByLink).forEach(crewList=>{
    if(!crewList.length) return;
    const lastUpdatedDate = crewList[0].lastUpdatedDate ? new Date(crewList[0].lastUpdatedDate) : new Date();
    const diffDays = Math.floor((selectedDate.getTime()-lastUpdatedDate.getTime())/(1000*60*60*24));
    const weeksPassed = Math.floor(diffDays/7);
    const dutiesPerRow = crewList.map(c=>c.duties||{});
    for(let rowIndex=0; rowIndex<crewList.length; rowIndex++){
      const crewIndex = ((rowIndex - weeksPassed) % crewList.length + crewList.length) % crewList.length;
      const crew = crewList[crewIndex];
      const dutyForRow = dutiesPerRow[rowIndex][weekday] ?? '';
      let outgoing='', incoming='', depTime='';
      if(dutyForRow && typeof dutyForRow === 'object' && (dutyForRow.outgoing||dutyForRow.incoming)){
        outgoing = (dutyForRow.outgoing||'').toString().trim();
        incoming = (dutyForRow.incoming||'').toString().trim();
        depTime = (dutyForRow.depTime||'').toString().trim();
      } else if(typeof dutyForRow === 'string') outgoing = dutyForRow.trim();
      const combined = (incoming ? `${outgoing}/${incoming}` : outgoing).toUpperCase();
      if(!combined || combined === 'REST') continue;
      const linkId = crew.linkId;

      const local = (localEdits[linkId] && localEdits[linkId][crew.crewIndex]) || {};
      const fb = (fbEdits[linkId] && fbEdits[linkId][crew.crewIndex]) || {};
      const ownerUid = fb._updatedBy || local._updatedBy || null;
      const ownerName = (fb._updatedByName || local._updatedByName) || null;

      const lpName =
        (local.crewLPName && local.crewLPName.trim()) ||
        (fb.crewLPName && fb.crewLPName.trim()) ||
        getDisplayNameFallback(crew); // uses crew.linkLabel when available

      const alpName =
        (local.crewALPName && local.crewALPName.trim()) ||
        (fb.crewALPName && fb.crewALPName.trim()) ||
        getDisplayNameFallback(crew);

      rows.push({
        depTime,
        outgoing,
        incoming,
        lpName,
        alpName,
        link: linkId,
        crewIndex: crew.crewIndex,
        ownerUid,
        ownerName,
        linkLabel: crew.linkLabel // may be null
      });
    }
  });

  function tmin(t){ if(!t) return Infinity; const m = t.match(/^(\d{1,2}):(\d{2})$/); return m ? (+m[1])*60 + (+m[2]) : Infinity; }
  rows.sort((a,b)=> tmin(a.depTime) - tmin(b.depTime));

  if(!rows.length){ dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No duties for ${weekday}</td></tr>`; setTableWrapPaddingAndHeader(); return; }

  dutyTable.innerHTML = '';
  rows.forEach(r=>{
    const outHtml = formatTrainToken(r.outgoing || '');
    const incHtml = formatTrainToken(r.incoming || '');

    // derive pill label: prefer JSON-provided linkLabel; otherwise fallback to computed label
    const shortLinkRaw = r.linkLabel && String(r.linkLabel).trim() ? r.linkLabel.trim() : fallbackShortLinkLabel(r.link || '');
    const shortLink = escapeHtml(shortLinkRaw);

    // train cell: top-left link pill, top-right dep time pill, center train number(s)
    const trainInner = (incHtml)
      ? `<div class="train-stack" role="group" aria-label="Train info for ${shortLink}">
           <div class="train-linklabel" aria-hidden="true">${shortLink}</div>
           <div class="train-deptime" aria-hidden="true">${escapeHtml(r.depTime||'')}</div>
           <div class="train-top">${outHtml}</div>
           <div class="train-divider" aria-hidden="true"></div>
           <div class="train-bottom">${incHtml}</div>
         </div>`
      : `<div class="train-stack" role="group" aria-label="Train info for ${shortLink}">
           <div class="train-linklabel" aria-hidden="true">${shortLink}</div>
           <div class="train-deptime" aria-hidden="true">${escapeHtml(r.depTime||'')}</div>
           <div class="train-top">${outHtml}</div>
         </div>`;

    const trainHtml = `<div class="cell-center">${trainInner}</div>`;

    const tr = document.createElement('tr');

    // Only admin can edit
    const mayEditLP = !!isAdmin;
    const mayEditALP = !!isAdmin;
    // show owner tag only if admin (so employees never see names/UIDs)
    const ownerTag = (isAdmin && r.ownerName) ? `<span class="ownerTag">${escapeHtml(r.ownerName)}</span>` : '';

    // Build cells (LP & ALP names bold via .editable CSS)
    const lpCell = `
      <td><div class="cell-center">
        <div class="editable" contenteditable="${mayEditLP? 'true':'false'}"
          data-link="${escapeHtml(r.link)}" data-crew="${r.crewIndex}"
          data-field="crewLPName" title="${mayEditLP? 'Edit LP name':'View only'}">
          ${escapeHtml(r.lpName)}
        </div>
      </div></td>
    `;

    const alpCell = `
      <td><div class="cell-center">
        <div class="editable" contenteditable="${mayEditALP? 'true':'false'}"
          data-link="${escapeHtml(r.link)}" data-crew="${r.crewIndex}"
          data-field="crewALPName" title="${mayEditALP? 'Edit ALP name':'View only'}">
          ${escapeHtml(r.alpName)}
        </div>
      </div></td>
    `;

    const trainCell = `<td>${trainHtml}</td>`;
    const depCell   = `<td><div class="cell-center">${escapeHtml(r.depTime||'')}</div></td>`;
    const linkCell  = `<td><div class="cell-center" title="${isAdmin ? escapeHtml(r.ownerUid || '') : ''}">${shortLink} ${ownerTag}</div></td>`;

    // Responsive order: if mobile show LP -> Train -> ALP, else original LP -> ALP -> Train
    if (isMobile()) {
      tr.innerHTML = `${lpCell}${trainCell}${alpCell}${depCell}${linkCell}`;
    } else {
      tr.innerHTML = `${lpCell}${alpCell}${trainCell}${depCell}${linkCell}`;
    }

    dutyTable.appendChild(tr);
  });

  /* Attach editable behavior - block focus for non-admins */
  document.querySelectorAll('.editable').forEach(el=>{
    if(el.__bound) return;
    el.__bound = true;

    el.addEventListener('pointerdown', (ev)=> { ev.stopPropagation(); }, {passive:true});

    el.addEventListener('focus', (ev)=>{
      if(!isAdmin){ el.blur(); return; }
      const link = el.dataset.link;
      const crew = Number(el.dataset.crew);
      const field = el.dataset.field;
      window.currentlyEditing = { link, crewIndex: crew, field };
      const txt = el.textContent.trim();
      if(/^(mao|rn|ol|sl|l)\d+/i.test(txt) || /^(lp|alp)\d+/i.test(txt)){
        el.dataset._orig = txt;
        el.textContent = '';
      } else {
        el.dataset._orig = '';
      }
      placeCaretAtEnd(el);
    });

    el.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Escape'){
        if(el.dataset._orig){ el.textContent = el.dataset._orig; el.blur(); }
      } else if(ev.key === 'Enter'){
        ev.preventDefault();
        el.blur();
      } else if ((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === 's') {
        ev.preventDefault();
        el.blur();
      }
    });

    el.addEventListener('blur', async (ev)=>{
      clearTimeout(window._commitDebounce);
      window._commitDebounce = setTimeout(async ()=>{
        if(!isAdmin){
          window.currentlyEditing = null;
          await renderCombinedDuties();
          return;
        }
        await onEditableCommit(ev);
        window.currentlyEditing = null;
      }, 220);
    });
  });

  setTimeout(setTableWrapPaddingAndHeader, 20);

  // restore editor focus if we were editing a particular cell before re-render
  if (editingInfo && editingInfo.link){
    const selector = `.editable[data-link="${escapeHtml(editingInfo.link)}"][data-crew="${editingInfo.crewIndex}"][data-field="${editingInfo.field}"]`;
    const restored = document.querySelector(selector);
    if(restored){
      restored.focus();
      placeCaretAtEnd(restored);
    }
  }
}

/* helper: resolve display name fallback for crew object (prefer JSON-provided linkLabel) */
function getDisplayNameFallback(crewObj){
  if(!crewObj) return '';
  if(crewObj.linkLabel && String(crewObj.linkLabel).trim()) return String(crewObj.linkLabel).trim();
  return fallbackShortLinkLabel(crewObj.linkId || '');
}

/* Commit handler (admin only) */
async function onEditableCommit(e){
  const el = e.currentTarget;
  if(!el) return;
  if(!isAdmin){
    await renderCombinedDuties();
    return;
  }

  const linkId = el.dataset.link;
  const crewIndex = Number(el.dataset.crew);
  const field = el.dataset.field;
  const newVal = el.textContent.trim();

  const userUid = (currentUser && currentUser.uid) ? currentUser.uid : (loadLocalUser()?.uid || createLocalUser().uid);
  const userReadable = (currentUser && (currentUser.email || currentUser.displayName)) || userUid;

  // clear locally & firebase if empty
  if(!newVal){
    if(localEdits[linkId] && localEdits[linkId][crewIndex]) {
      delete localEdits[linkId][crewIndex].crewLPName;
      delete localEdits[linkId][crewIndex].crewALPName;
      delete localEdits[linkId][crewIndex]._updatedBy;
      delete localEdits[linkId][crewIndex]._updatedByName;
      delete localEdits[linkId][crewIndex]._updatedAt;
      if(Object.keys(localEdits[linkId][crewIndex]).length === 0) delete localEdits[linkId][crewIndex];
    }
    saveLocalEdits();
    showToast('Cleared locally');

    if(firebaseDb){
      try{
        const path = `/edits/${linkId}/${crewIndex}`;
        const payload = {};
        payload[field] = null;
        payload._updatedBy = null;
        payload._updatedByName = null;
        payload._updatedAt = null;
        await firebaseDb.ref(path).update(payload);
        showToast('Cleared on Firebase');
      }catch(err){
        console.error('Firebase clear failed', err);
        showToast('Firebase clear failed');
      }
    }
    await renderCombinedDuties();
    return;
  }

  // set value + owner to admin locally
  if(!localEdits[linkId]) localEdits[linkId] = {};
  if(!localEdits[linkId][crewIndex]) localEdits[linkId][crewIndex] = {};
  localEdits[linkId][crewIndex][field] = newVal;
  localEdits[linkId][crewIndex]['_updatedBy'] = userUid;
  localEdits[linkId][crewIndex]['_updatedByName'] = userReadable;
  localEdits[linkId][crewIndex]['_updatedAt'] = new Date().toISOString();
  saveLocalEdits();
  showToast('Saved locally');

  // push to firebase (best-effort)
  if(firebaseDb){
    try{
      const path = `/edits/${linkId}/${crewIndex}`;
      const payload = { [field]: newVal, _updatedBy: userUid, _updatedByName: userReadable, _updatedAt: new Date().toISOString() };
      await firebaseDb.ref(path).update(payload);
      showToast('Synced to Firebase');
    }catch(err){
      console.error('Firebase push failed', err);
      showToast('Firebase sync failed');
    }
  }

  await renderCombinedDuties();
}

/* Admin sign-in UI (unchanged) */
if(adminSignInBtn){
  adminSignInBtn.addEventListener('click', async ()=>{
    if(!firebaseAuth){
      alert('Firebase not initialized.');
      return;
    }
    const choice = confirm('Use existing admin account to sign in? OK = Sign in, Cancel = Sign out');
    if(!choice){
      try { await firebaseAuth.signOut(); showToast('Signed out'); await detectAdmin(); await renderCombinedDuties(); updateLoginStatusUI(); } catch(e){ console.warn(e); }
      return;
    }
    const email = prompt('Admin email:');
    if(!email) return;
    const pwd = prompt('Password:');
    if(!pwd) return;
    try {
      const cred = await firebaseAuth.signInWithEmailAndPassword(email, pwd);
      const fbUser = firebaseAuth.currentUser || (cred && cred.user);
      if(fbUser){
        currentUser = {
          uid: fbUser.uid,
          displayName: fbUser.displayName || fbUser.email || fbUser.uid,
          email: fbUser.email || null,
          anon: !!fbUser.isAnonymous
        };
        saveLocalUser(currentUser);
      }
      showToast('Signed in');
      await detectAdmin();
      await renderCombinedDuties();
      updateLoginStatusUI();
      console.log('Admin signed in:', currentUser);
    } catch (err){
      console.error('Sign-in failed', err);
      alert('Sign-in failed: ' + (err.message || err));
    }
  });
}

/* Admin detection */
async function detectAdmin(){
  currentUser = currentUser || loadLocalUser() || createLocalUser();
  isAdmin = false;
  try{
    const ADMIN_UIDS = []; // optional local override
    if(ADMIN_UIDS.includes(currentUser.uid)) isAdmin = true;
    if(firebaseDb && currentUser && currentUser.uid){
      const snap = await firebaseDb.ref(`/meta/admins/${currentUser.uid}`).once('value');
      if(snap.exists() && snap.val() === true) isAdmin = true;
    }
  }catch(e){ console.warn('admin detect err', e); }
  console.log('detectAdmin -> currentUser.uid=', currentUser && currentUser.uid, 'isAdmin=', isAdmin);
  updateLoginStatusUI();
}

/* login status UI */
function updateLoginStatusUI(){
  const u = currentUser || loadLocalUser();
  if(!u){
    loginStatus.textContent = '';
    notice.style.display = '';
    adminSignInBtn.style.display = 'inline-block';
    return;
  }
  if(isAdmin){
    loginStatus.textContent = 'Admin â€” editing enabled';
    notice.style.display = 'none';
  } else {
    loginStatus.textContent = '';
    notice.style.display = '';
  }
  adminSignInBtn.style.display = 'inline-block';
}

/* init */
async function init(){
  setSelectedDate(new Date());
  currentUser = loadLocalUser() || createLocalUser();
  saveLocalUser(currentUser);
  localEdits = loadLocalEdits();

  renderTableHead();
  await loadAllLinks();
  window.addEventListener('resize', () => {
    renderTableHead();
    setTimeout(setTableWrapPaddingAndHeader, 60);
    renderCombinedDuties();
  });
  window.addEventListener('orientationchange', () => {
    renderTableHead();
    setTimeout(setTableWrapPaddingAndHeader, 140);
    renderCombinedDuties();
  });
  if(document.fonts && document.fonts.ready) document.fonts.ready.then(() => setTimeout(setTableWrapPaddingAndHeader, 80));
  updateLoginStatusUI();

  if (mql && mql.addEventListener) {
    mql.addEventListener('change', () => { renderTableHead(); renderCombinedDuties(); });
  } else if (mql && mql.addListener) {
    mql.addListener(() => { renderTableHead(); renderCombinedDuties(); });
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
