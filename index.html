<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LP/ALP Duty List â€” Madgaon Lobby</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --muted:#6b7280; --accent:#0f172a; --accent-2:#2563eb; --radius:12px;
      --divider:#e6eefc;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--accent)}
    .wrap{max-width:1100px;margin:20px auto;padding:14px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 24px rgba(15,23,42,0.06);padding:18px}
    header{text-align:center}
    h1{margin:0;font-size:1.6rem;font-weight:700}
    .sub{font-size:1rem;color:var(--muted);font-weight:600;margin-top:4px}
    #dateHeading{font-size:1rem;font-weight:600;color:var(--accent-2);margin-top:8px}

    .controls{text-align:center;margin:16px 0}
    .date-icon-btn{
      display:inline-flex;align-items:center;justify-content:center;background:var(--accent-2);color:#fff;border:none;border-radius:50%;
      width:48px;height:48px;font-size:1.4rem;cursor:pointer;box-shadow:0 4px 10px rgba(37,99,235,0.25);
      transition:transform .08s ease;
    }
    .date-icon-btn:active{transform:scale(0.96)}
    input[type="date"].native-date{position:absolute;left:-9999px}

    /* table container allows horizontal scroll on small screens when needed */
    .tableWrap{overflow-x:auto;border-radius:10px;margin-top:12px;background:linear-gradient(#fff,#fff);padding:6px}
    table{width:100%;border-collapse:collapse;min-width:720px;table-layout:fixed}
    thead th{background:#f8fafc;padding:12px 16px;text-align:left;color:var(--muted);font-weight:700;border-top:1px solid #f1f4f8;white-space:nowrap}
    tbody td{padding:12px 16px;border-top:1px solid #f6f9fc;font-size:0.95rem;color:var(--accent);vertical-align:top}
    tbody tr:nth-child(odd){background:transparent}
    .no-data{text-align:center;color:var(--muted);padding:14px}

    /* Column widths: LP / ALP / Train get priority */
    thead th:nth-child(1), tbody td:nth-child(1) { width: 30%; }
    thead th:nth-child(2), tbody td:nth-child(2) { width: 30%; }
    thead th:nth-child(3), tbody td:nth-child(3) { width: 25%; }
    thead th:nth-child(4), tbody td:nth-child(4) { width: 7%; }
    thead th:nth-child(5), tbody td:nth-child(5) { width: 8%; }

    /* train stack styles inside cell */
    .train-stack{display:flex;flex-direction:column;align-items:flex-start;gap:6px}
    .train-top, .train-bottom{line-height:1.05;font-weight:700}
    .train-top{font-size:1rem}
    .train-bottom{font-size:0.95rem;color:var(--muted);font-weight:600}
    .train-divider{width:100%;height:6px;background:linear-gradient(to right,var(--divider),transparent);border-radius:2px;align-self:stretch;opacity:0.9}

    /* make LP/ALP/trains wrap and truncate if too long */
    tbody td:nth-child(1), tbody td:nth-child(2), tbody td:nth-child(3) {
      white-space:normal;
      overflow:hidden;
      text-overflow:ellipsis;
      hyphens:auto;
      word-break:break-word;
    }

    /* On smaller screens keep columns but hide Dep & Link to ensure LP/ALP/Train fit
       and reduce padding/font-size to display more content. */
    @media (max-width:600px){
      table{min-width:0; table-layout:auto}
      thead th, tbody td{padding:8px 10px;font-size:14px}
      /* hide Dep (4) and Link No (5) columns */
      thead th:nth-child(4), thead th:nth-child(5),
      tbody td:nth-child(4), tbody td:nth-child(5) {
        display:none;
      }
      /* ensure LP/ALP/Train occupy available width and wrap nicely */
      thead th:nth-child(1), tbody td:nth-child(1),
      thead th:nth-child(2), tbody td:nth-child(2),
      thead th:nth-child(3), tbody td:nth-child(3) {
        width: auto;
      }
      /* slightly smaller date icon */
      .date-icon-btn{width:46px;height:46px;font-size:1.3rem}
      .train-top{font-size:1rem}
      .train-bottom{font-size:0.9rem}
    }

    /* Mid-size screens (tablet) reduce min-width */
    @media (min-width:601px) and (max-width:900px){
      table{min-width:680px}
      thead th, tbody td{padding:10px 12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-label="Duty viewer">
      <header>
        <h1>LP/ALP Duty List</h1>
        <div class="sub">Madgaon Lobby</div>
        <div id="dateHeading" aria-live="polite">Loading date...</div>
      </header>

      <div class="controls">
        <button id="dateBtn" class="date-icon-btn" aria-label="Select Date">ðŸ“…</button>
        <input type="date" id="datePicker" class="native-date" aria-label="Date Picker" />
      </div>

      <div class="tableWrap" aria-live="polite">
        <table>
          <thead>
            <tr>
              <th>Name of LP</th>
              <th>Name of ALP</th>
              <th>Train No</th>
              <th>Dep</th>
              <th>Link No</th>
            </tr>
          </thead>
          <tbody id="dutyTable">
            <tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* Loads multiple link files, flattens crew data, applies per-link weekly rotation,
   and displays combined duties sorted by depTime. Train cell now stacks outgoing
   and incoming trains in the same cell with a divider.
*/

const linkFiles = [
  'link1.json','link2.json','link3.json','link4.json',
  'rnlink1.json','rnlink2.json','rnlink3.json',
  'ollink1.json','sllink1.json'
];

let allCrewData = [];
let selectedDate = new Date();

const dateBtn = document.getElementById('dateBtn');
const datePicker = document.getElementById('datePicker');
const dateHeading = document.getElementById('dateHeading');
const dutyTable = document.getElementById('dutyTable');

dateBtn.addEventListener('click', () => { datePicker.focus(); datePicker.click(); });
datePicker.addEventListener('change', () => {
  selectedDate = datePicker.value ? new Date(datePicker.value + 'T00:00:00') : new Date();
  updateDateHeading();
  renderCombinedDuties();
});

function updateDateHeading(){
  const d = selectedDate || new Date();
  dateHeading.textContent = `${d.toLocaleString('en-US',{weekday:'long'})}, ${d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`;
}
function setSelectedDate(d){
  selectedDate = d || new Date();
  const yyyy = selectedDate.getFullYear(), mm = String(selectedDate.getMonth()+1).padStart(2,'0'), dd = String(selectedDate.getDate()).padStart(2,'0');
  datePicker.value = `${yyyy}-${mm}-${dd}`;
  updateDateHeading();
}

// Load all link files in parallel; skip failures
async function loadAllLinks() {
  dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>`;
  const fetches = linkFiles.map(async file => {
    try {
      const r = await fetch(file, { cache: 'no-cache' });
      if (!r.ok) throw new Error(file + ' ' + r.status);
      return await r.json();
    } catch (e) {
      console.warn('Failed to load', file, e);
      return null;
    }
  });

  const results = await Promise.all(fetches);
  allCrewData = [];

  results.forEach((linkData, idx) => {
    if (!linkData) return;
    const linkId = linkData.linkId ?? (`file#${idx+1}`);
    const lastUpdated = linkData.lastUpdated ? new Date(linkData.lastUpdated) : new Date();
    const crewArr = Array.isArray(linkData.crew) ? linkData.crew : [];
    crewArr.forEach((crew, crewIndex) => {
      allCrewData.push({
        ...crew,
        linkId,
        lastUpdatedDate: lastUpdated,
        crewIndex
      });
    });
  });

  renderCombinedDuties();
}

// Flattened rotation + filter + sort by depTime
function renderCombinedDuties() {
  if (!allCrewData.length) {
    dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No data available</td></tr>`;
    return;
  }

  const weekday = selectedDate.toLocaleString('en-US', { weekday: 'long' });

  // Group crew entries by linkId so we can apply rotation per link
  const crewsByLink = allCrewData.reduce((acc, crew) => {
    (acc[crew.linkId] = acc[crew.linkId] || []).push(crew);
    return acc;
  }, {});

  const rows = [];

  Object.values(crewsByLink).forEach(crewList => {
    if (!crewList.length) return;

    // use the lastUpdatedDate from first entry of this link
    const lastUpdatedDate = crewList[0].lastUpdatedDate ? new Date(crewList[0].lastUpdatedDate) : new Date();
    const diffMs = selectedDate.getTime() - lastUpdatedDate.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const weeksPassed = Math.floor(diffDays / 7);

    // duties arranged per row index (as in your rotation model)
    const dutiesPerRow = crewList.map(c => c.duties || {});

    for (let rowIndex = 0; rowIndex < crewList.length; rowIndex++) {
      // rotated crew index for selected week
      const crewIndex = ((rowIndex - weeksPassed) % crewList.length + crewList.length) % crewList.length;
      const crew = crewList[crewIndex];

      const dutyForRow = dutiesPerRow[rowIndex][weekday] ?? '';

      let outgoing = '';
      let incoming = '';
      let depTime = '';

      if (dutyForRow && typeof dutyForRow === 'object' && (dutyForRow.outgoing || dutyForRow.incoming)) {
        outgoing = (dutyForRow.outgoing || '').toString().trim();
        incoming = (dutyForRow.incoming || '').toString().trim();
        depTime = (dutyForRow.depTime || '').toString().trim();
      } else if (typeof dutyForRow === 'string') {
        outgoing = dutyForRow.trim();
      }

      // skip empty or REST
      const combinedCheck = (incoming ? `${outgoing}/${incoming}` : outgoing).toUpperCase();
      if (!combinedCheck || combinedCheck === 'REST') continue;

      // prefer the crew names if present, else use IDs
      const lpName = (crew.crewLPName && crew.crewLPName.trim()) ? crew.crewLPName.trim() : (crew.crewLPId || '');
      const alpName = (crew.crewALPName && crew.crewALPName.trim()) ? crew.crewALPName.trim() : (crew.crewALPId || '');

      rows.push({
        depTime,
        outgoing,
        incoming,
        trainDisplay: { outgoing, incoming },
        lpName,
        alpName,
        link: crew.linkId
      });
    }
  });

  // parse time to minutes (HH:MM). invalid or missing => Infinity (sorted last)
  function timeToMinutes(t) {
    if (!t || typeof t !== 'string') return Infinity;
    const m = t.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return Infinity;
    const hh = parseInt(m[1], 10), mm = parseInt(m[2], 10);
    if (!isFinite(hh) || !isFinite(mm)) return Infinity;
    return hh * 60 + mm;
  }

  rows.sort((a, b) => timeToMinutes(a.depTime) - timeToMinutes(b.depTime));

  // render rows
  if (!rows.length) {
    dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No duties for ${weekday}</td></tr>`;
    return;
  }

  dutyTable.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');

    // build train cell HTML: if incoming exists, stack with divider, else show single line
    let trainCellHtml = '';
    const out = escapeHtml(r.trainDisplay.outgoing || '');
    const inc = escapeHtml(r.trainDisplay.incoming || '');
    if (inc) {
      trainCellHtml = `
        <div class="train-stack" role="group" aria-label="Train numbers">
          <div class="train-top">${out}</div>
          <div class="train-divider" aria-hidden="true"></div>
          <div class="train-bottom">${inc}</div>
        </div>
      `;
    } else {
      trainCellHtml = `<div class="train-stack"><div class="train-top">${out}</div></div>`;
    }

    tr.innerHTML = `
      <td data-label="Name of LP">${escapeHtml(r.lpName)}</td>
      <td data-label="Name of ALP">${escapeHtml(r.alpName)}</td>
      <td data-label="Train No">${trainCellHtml}</td>
      <td data-label="Dep">${escapeHtml(r.depTime || '')}</td>
      <td data-label="Link No">${escapeHtml(r.link)}</td>
    `;
    dutyTable.appendChild(tr);
  });
}

function escapeHtml(s) {
  if (s == null) return '';
  return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
}

// init
(function init() {
  setSelectedDate(new Date());
  loadAllLinks().catch(e => {
    console.error('Error loading links', e);
    dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">Error loading data</td></tr>`;
  });
})();

function setSelectedDate(d) {
  selectedDate = d || new Date();
  const yyyy = selectedDate.getFullYear();
  const mm = String(selectedDate.getMonth() + 1).padStart(2, '0');
  const dd = String(selectedDate.getDate()).padStart(2, '0');
  datePicker.value = `${yyyy}-${mm}-${dd}`;
  updateDateHeading();
}
</script>
</body>
</html>
