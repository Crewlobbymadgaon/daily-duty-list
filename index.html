<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LP/ALP Duty List â€” Madgaon Lobby</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f4f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0f172a;
      --accent-2: #2563eb;
      --radius: 12px;
      --divider: #1f6feb;      /* accent divider color */
      --border: #cdd4e1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--accent);
    }
    .wrap { max-width: 1100px; margin: 20px auto; padding: 14px; }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
      padding: 18px;
    }
    header { text-align: center; }
    h1 { margin: 0; font-size: 1.6rem; font-weight: 700; }
    .sub { font-size: 1rem; color: var(--muted); font-weight: 600; margin-top: 4px; }
    #dateHeading { font-size: 1rem; font-weight: 600; color: var(--accent-2); margin-top: 8px; }

    .controls { text-align: center; margin: 12px 0 18px; display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap }
    .nav-btn {
      background: transparent;
      border: 1px solid rgba(15,23,42,0.06);
      width:40px;height:40px;border-radius:8px;
      display:inline-flex;align-items:center;justify-content:center;
      cursor:pointer;font-size:1.05rem;color:var(--accent);
      box-shadow: 0 2px 6px rgba(15,23,42,0.04);
    }
    .nav-btn:active{transform:translateY(1px)}
    .date-icon-btn {
      display:inline-flex;align-items:center;justify-content:center;
      background:var(--accent-2);color:#fff;border:none;border-radius:10px;
      min-width:48px;height:40px;font-size:1.05rem;padding:0 10px;cursor:pointer;
      box-shadow: 0 6px 18px rgba(37,99,235,0.12);
    }
    .date-icon-btn:active { transform: scale(0.98); }
    input[type="date"].native-date { position: absolute; left: -9999px; }

    /* Table container */
    .tableWrap {
      overflow-x: auto;
      border-radius: 10px;
      margin-top: 12px;
      background: #fff;
      padding: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 720px;
      table-layout: fixed;
      border: 1px solid var(--border);
    }
    thead th {
      background: #f8fafc;
      padding: 10px 12px;
      text-align: center;
      color: var(--muted);
      font-weight: 700;
      border: 1px solid var(--border);
      white-space: nowrap;
    }
    tbody td {
      padding: 10px 12px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      color: var(--accent);
      vertical-align: middle;
      text-align: center;
    }
    tbody tr:nth-child(odd) { background: #fbfdff; }
    .no-data { text-align: center; color: var(--muted); padding: 14px; }

    /* Column widths */
    thead th:nth-child(1), tbody td:nth-child(1) { width: 30%; }
    thead th:nth-child(2), tbody td:nth-child(2) { width: 30%; }
    thead th:nth-child(3), tbody td:nth-child(3) { width: 25%; }
    thead th:nth-child(4), tbody td:nth-child(4) { width: 7%; }
    thead th:nth-child(5), tbody td:nth-child(5) { width: 8%; }

    /* Center wrappers */
    .cell-center { display: flex; align-items: center; justify-content: center; min-height: 40px; }

    /* Train stack: make train text inline-block so divider width matches text width */
    .train-stack { display: inline-flex; flex-direction: column; align-items: center; gap: 6px; padding: 4px 6px; }
    .train-top, .train-bottom {
      line-height: 1.1;
      font-weight: 400;
      color: var(--accent);
      font-size: 0.95rem;
      display:inline-block;
    }
    .train-divider {
      width: 100%;               /* fills the train-stack width (matches text width) */
      max-width: 240px;          /* reasonable cap so very long text doesn't make divider huge */
      height: 2px;               /* more visible */
      background: var(--divider);
      border-radius: 2px;
      margin: 0;
    }

    /* text wrap for LP/ALP/Train */
    tbody td:nth-child(1), tbody td:nth-child(2), tbody td:nth-child(3) {
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      hyphens: auto;
      word-break: break-word;
    }

    /* Mobile adjustments: hide Dep & Link columns for space */
    @media (max-width: 600px) {
      table { min-width: 0; table-layout: auto; font-size: 14px; }
      thead th, tbody td { padding: 8px 10px; }
      thead th:nth-child(4), thead th:nth-child(5),
      tbody td:nth-child(4), tbody td:nth-child(5) { display: none; }
      .date-icon-btn { min-width:44px;height:38px;font-size:1.0rem;padding:0 8px }
      .train-top, .train-bottom { font-size: 0.90rem; }
      .train-divider { max-width:160px; height:1.5px; }
      .cell-center { min-height:42px; }
      .nav-btn { width:36px;height:36px;font-size:0.95rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-label="Duty viewer">
      <header>
        <h1>LP/ALP Duty List</h1>
        <div class="sub">Madgaon Lobby</div>
        <div id="dateHeading" aria-live="polite">Loading date...</div>
      </header>

      <div class="controls" role="toolbar" aria-label="Date controls">
        <button id="prevDay" class="nav-btn" title="Previous day" aria-label="Previous day">â—€</button>

        <button id="dateBtn" class="date-icon-btn" aria-label="Open date picker">ðŸ“…</button>
        <input type="date" id="datePicker" class="native-date" aria-label="Date Picker" />

        <button id="nextDay" class="nav-btn" title="Next day" aria-label="Next day">â–¶</button>
      </div>

      <div class="tableWrap" aria-live="polite">
        <table>
          <thead>
            <tr>
              <th>Name of LP</th>
              <th>Name of ALP</th>
              <th>Train No</th>
              <th>Dep</th>
              <th>Link No</th>
            </tr>
          </thead>
          <tbody id="dutyTable">
            <tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* Loads multiple link files, flattens crew data, applies per-link weekly rotation,
   displays combined duties sorted by depTime. Navigator arrows advance/decrease date.
*/

const linkFiles = [
  'link1.json','link2.json','link3.json','link4.json',
  'rnlink1.json','rnlink2.json','rnlink3.json',
  'ollink1.json','sllink1.json'
];

let allCrewData = [];
let selectedDate = new Date();

const prevBtn = document.getElementById('prevDay');
const nextBtn = document.getElementById('nextDay');
const dateBtn = document.getElementById('dateBtn');
const datePicker = document.getElementById('datePicker');
const dateHeading = document.getElementById('dateHeading');
const dutyTable = document.getElementById('dutyTable');

// date picker open
dateBtn.addEventListener('click', () => { datePicker.focus(); datePicker.click(); });
datePicker.addEventListener('change', () => {
  selectedDate = datePicker.value ? new Date(datePicker.value + 'T00:00:00') : new Date();
  updateDateHeading();
  renderCombinedDuties();
});

// prev/next handlers
prevBtn.addEventListener('click', () => changeDate(-1));
nextBtn.addEventListener('click', () => changeDate(1));

function changeDate(offsetDays) {
  const d = new Date(selectedDate.getTime());
  d.setDate(d.getDate() + offsetDays);
  setSelectedDate(d);
  renderCombinedDuties();
}

function updateDateHeading() {
  const d = selectedDate || new Date();
  dateHeading.textContent = `${d.toLocaleString('en-US',{weekday:'long'})}, ${d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`;
}
function setSelectedDate(d) {
  selectedDate = d || new Date();
  const yyyy = selectedDate.getFullYear();
  const mm = String(selectedDate.getMonth() + 1).padStart(2, '0');
  const dd = String(selectedDate.getDate()).padStart(2, '0');
  datePicker.value = `${yyyy}-${mm}-${dd}`;
  updateDateHeading();
}

// load link files
async function loadAllLinks() {
  dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>`;
  const fetches = linkFiles.map(async file => {
    try {
      const r = await fetch(file, { cache: 'no-cache' });
      if (!r.ok) throw new Error(file + ' ' + r.status);
      return await r.json();
    } catch (e) {
      console.warn('Failed to load', file, e);
      return null;
    }
  });

  const results = await Promise.all(fetches);
  allCrewData = [];

  results.forEach((linkData, idx) => {
    if (!linkData) return;
    const linkId = linkData.linkId ?? (`file#${idx+1}`);
    const lastUpdated = linkData.lastUpdated ? new Date(linkData.lastUpdated) : new Date();
    const crewArr = Array.isArray(linkData.crew) ? linkData.crew : [];
    crewArr.forEach((crew, crewIndex) => {
      allCrewData.push({
        ...crew,
        linkId,
        lastUpdatedDate: lastUpdated,
        crewIndex
      });
    });
  });

  renderCombinedDuties();
}

// rotation + flatten + filter + sort
function renderCombinedDuties() {
  if (!allCrewData.length) {
    dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No data available</td></tr>`;
    return;
  }

  const weekday = selectedDate.toLocaleString('en-US', { weekday: 'long' });

  const crewsByLink = allCrewData.reduce((acc, crew) => {
    (acc[crew.linkId] = acc[crew.linkId] || []).push(crew);
    return acc;
  }, {});

  const rows = [];

  Object.values(crewsByLink).forEach(crewList => {
    if (!crewList.length) return;

    const lastUpdatedDate = crewList[0].lastUpdatedDate ? new Date(crewList[0].lastUpdatedDate) : new Date();
    const diffMs = selectedDate.getTime() - lastUpdatedDate.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const weeksPassed = Math.floor(diffDays / 7);

    const dutiesPerRow = crewList.map(c => c.duties || {});

    for (let rowIndex = 0; rowIndex < crewList.length; rowIndex++) {
      const crewIndex = ((rowIndex - weeksPassed) % crewList.length + crewList.length) % crewList.length;
      const crew = crewList[crewIndex];
      const dutyForRow = dutiesPerRow[rowIndex][weekday] ?? '';

      let outgoing = '', incoming = '', depTime = '';
      if (dutyForRow && typeof dutyForRow === 'object' && (dutyForRow.outgoing || dutyForRow.incoming)) {
        outgoing = (dutyForRow.outgoing || '').toString().trim();
        incoming = (dutyForRow.incoming || '').toString().trim();
        depTime = (dutyForRow.depTime || '').toString().trim();
      } else if (typeof dutyForRow === 'string') outgoing = dutyForRow.trim();

      const check = (incoming ? `${outgoing}/${incoming}` : outgoing).toUpperCase();
      if (!check || check === 'REST') continue;

      const lpName = crew.crewLPName?.trim() || crew.crewLPId || '';
      const alpName = crew.crewALPName?.trim() || crew.crewALPId || '';

      rows.push({ depTime, outgoing, incoming, lpName, alpName, link: crew.linkId });
    }
  });

  function timeToMinutes(t) {
    if (!t) return Infinity;
    const m = t.match(/^(\d{1,2}):(\d{2})$/);
    return m ? +m[1]*60 + +m[2] : Infinity;
  }

  rows.sort((a,b)=>timeToMinutes(a.depTime)-timeToMinutes(b.depTime));

  if (!rows.length) {
    dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No duties for ${weekday}</td></tr>`;
    return;
  }

  dutyTable.innerHTML = '';
  rows.forEach(r=>{
    const out = escapeHtml(r.outgoing||''), inc = escapeHtml(r.incoming||'');
    // train-stack container width adapts to text width (inline-flex); divider width = 100% of that container
    const trainCell = inc ? `
      <div class="cell-center">
        <div class="train-stack" role="group" aria-label="Train numbers">
          <div class="train-top">${out}</div>
          <div class="train-divider" aria-hidden="true"></div>
          <div class="train-bottom">${inc}</div>
        </div>
      </div>` :
      `<div class="cell-center"><div class="train-stack"><div class="train-top">${out}</div></div></div>`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="cell-center">${escapeHtml(r.lpName)}</div></td>
      <td><div class="cell-center">${escapeHtml(r.alpName)}</div></td>
      <td>${trainCell}</td>
      <td><div class="cell-center">${escapeHtml(r.depTime||'')}</div></td>
      <td><div class="cell-center">${escapeHtml(r.link)}</div></td>
    `;
    dutyTable.appendChild(tr);
  });
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
}

// init
(function init(){
  setSelectedDate(new Date());
  loadAllLinks();
})();

</script>
</body>
</html>
