<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>LP/ALP Duty Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    select, input[type="date"] { padding: 5px; margin-bottom: 10px; }
    .rest { background-color: #ffe0e0; }
    #dateHeading { font-size: 18px; margin-bottom: 10px; font-weight: bold; }
    .controls { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h2>LP/ALP Duty Viewer</h2>
  <div id="dateHeading"></div>

  <div class="controls">
    <label for="daySelect">Select Day: </label>
    <select id="daySelect">
      <option>Sunday</option>
      <option>Monday</option>
      <option>Tuesday</option>
      <option>Wednesday</option>
      <option>Thursday</option>
      <option>Friday</option>
      <option>Saturday</option>
    </select>

    &nbsp;&nbsp;

    <label for="datePicker">Select Date: </label>
    <input type="date" id="datePicker" />
  </div>

  <table>
    <thead>
      <tr>
        <th>LP ID</th>
        <th>ALP ID</th>
        <th>Train No</th>
        <th>Dep Time</th>
        <th>Link Number</th>
      </tr>
    </thead>
    <tbody id="dutyTable"></tbody>
  </table>

  <script>
    let crewData = [];
    let linkNumber = 1;
    let lastUpdatedDate;
    let currentCrewIndex;

    const daysArray = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

    fetch('link1.json')
      .then(response => response.json())
      .then(data => {
        lastUpdatedDate = new Date(data.lastUpdated);
        currentCrewIndex = data.currentCrewIndex || 0;
        linkNumber = data.linkId || 1;
        crewData = data.crew || [];

        // Initialize controls to today
        const today = new Date();
        document.getElementById('datePicker').valueAsDate = today;
        const todayDayName = today.toLocaleString('en-US', { weekday: 'long' });
        document.getElementById('daySelect').value = todayDayName;

        document.getElementById('daySelect').addEventListener('change', () => {
          syncDatePickerToDay();
          renderTable();
        });

        document.getElementById('datePicker').addEventListener('change', () => {
          syncDaySelectToDate();
          renderTable();
        });

        renderTable();
      });
function renderTable() {
  if (!crewData.length) return;

  const selectedDate = getSelectedDate();
  const selectedDay = document.getElementById('daySelect').value;

  // Calculate weeks passed from lastUpdatedDate to selectedDate
  const diffMs = selectedDate.getTime() - lastUpdatedDate.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  const weeksPassed = Math.floor(diffDays / 7);

  updateDateHeading(selectedDate);

  // duties fixed per row (index)
  const dutiesPerRow = crewData.map(crew => crew.duties);

  // Build array of rows with depTime info for sorting
  const rows = [];

  for (let rowIndex = 0; rowIndex < crewData.length; rowIndex++) {
    // Crew assigned to this row this week, shifted by weeksPassed
    const crewIndex = (rowIndex - weeksPassed + crewData.length) % crewData.length;
    const crew = crewData[crewIndex];

    // Duties fixed by row (do NOT rotate duties, duties stay fixed per row)
    const dutyForThisRow = dutiesPerRow[rowIndex][selectedDay] || '';

    let trainNo = '';
    let depTime = null; // null means no departure time / REST

    if (typeof dutyForThisRow === 'object' && dutyForThisRow.outgoing) {
      trainNo = `${dutyForThisRow.outgoing}/${dutyForThisRow.incoming || ''}`;
      depTime = dutyForThisRow.depTime || null;
    } else if (typeof dutyForThisRow === 'string') {
      trainNo = dutyForThisRow.toUpperCase() === 'REST' ? 'REST' : dutyForThisRow;
    }

    rows.push({
      crewLPId: crew.crewLPId,
      crewALPId: crew.crewALPId,
      trainNo,
      depTime,
      isRest: trainNo === 'REST',
    });
  }

  // Sort rows by depTime ascending; REST or no depTime pushed to bottom
  rows.sort((a, b) => {
    if (a.isRest && !b.isRest) return 1;
    if (!a.isRest && b.isRest) return -1;
    if (a.depTime && b.depTime) {
      return timeStringToMinutes(a.depTime) - timeStringToMinutes(b.depTime);
    }
    if (a.depTime && !b.depTime) return -1;
    if (!a.depTime && b.depTime) return 1;
    return 0;
  });

  // Render sorted rows in table body
  const tbody = document.getElementById('dutyTable');
  tbody.innerHTML = '';

  for (const row of rows) {
    const tr = document.createElement('tr');
    if (row.isRest) tr.classList.add('rest');

    tr.innerHTML = `
      <td>${row.crewLPId}</td>
      <td>${row.crewALPId}</td>
      <td>${row.trainNo}</td>
      <td>${row.depTime || ''}</td>
      <td>${linkNumber}</td>
    `;
    tbody.appendChild(tr);
  }
}

// Helper: Convert HH:MM string to minutes number for sorting
function timeStringToMinutes(timeStr) {
  if (!timeStr) return Infinity;
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
}

    function getSelectedDate() {
      const dateInput = document.getElementById('datePicker').value;
      return dateInput ? new Date(dateInput) : new Date();
    }

    function updateDateHeading(date) {
      const formattedDate = date.toLocaleDateString('en-GB', {
        day: '2-digit', month: 'short', year: 'numeric'
      });
      const dayName = date.toLocaleString('en-US', { weekday: 'long' });
      document.getElementById('dateHeading').textContent = `${dayName}, ${formattedDate}`;
    }

    function syncDatePickerToDay() {
      const selectedDay = document.getElementById('daySelect').value;
      const today = new Date();
      const todayIndex = today.getDay();
      const targetIndex = daysArray.indexOf(selectedDay);
      let dayDiff = targetIndex - todayIndex;
      if (dayDiff < 0) dayDiff += 7;
      const targetDate = new Date();
      targetDate.setDate(today.getDate() + dayDiff);
      document.getElementById('datePicker').valueAsDate = targetDate;
    }

    function syncDaySelectToDate() {
      const selectedDate = getSelectedDate();
      const dayName = selectedDate.toLocaleString('en-US', { weekday: 'long' });
      document.getElementById('daySelect').value = dayName;
    }
  </script>
</body>
</html>
