<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>LP/ALP Duty Viewer - Combined Links</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    select, input[type="date"] { padding: 5px; margin-bottom: 10px; }
    .rest { background-color: #ffe0e0; }
    #dateHeading { font-size: 18px; margin-bottom: 10px; font-weight: bold; }
    .controls { margin-bottom: 15px; }
  </style>
</head>
<body>
  <body class="bg-gray-50 text-gray-900">

  <!-- HEADER -->
  <header style="
  background: linear-gradient(90deg, #2563eb, #4f46e5);
  color: white;
  padding: 1.5rem 1.75rem;
  box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
  border-radius: 0 0 12px 12px;
  max-width: 800px;
  margin: 0 auto 1.5rem auto;
  text-align: center;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
">

  <h1 style="font-size: 2.5rem; font-weight: 700; margin: 0 0 0.3rem;">Combined Crew Lobby Madgaon</h1>
  <p style="font-size: 1.9rem; opacity: 0.9; margin: 0 0 1rem;">Crew Duty List</p>

  <div id="dateHeading" style="font-weight: 700; font-size: 1.25rem; margin-bottom: 16px; color: #c7d2fe;"></div>

  <div class="controls" style="
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 16px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #e0e7ff;
    font-weight: 600;
    font-size: 1.1rem;
  ">
    <label for="daySelect" style="display: flex; align-items: center; gap: 10px; cursor: pointer; background: rgba(255 255 255 / 0.15); padding: 8px 12px; border-radius: 8px; border: 1.5px solid #a5b4fc;">
      <span>Select Day:</span>
      <select id="daySelect" style="
        padding: 7px 10px;
        border-radius: 6px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        background: #818cf8;
        color: white;
        min-width: 130px;
        box-shadow: 0 0 5px #6366f1a0;
      ">
        <option>Sunday</option>
        <option>Monday</option>
        <option>Tuesday</option>
        <option>Wednesday</option>
        <option>Thursday</option>
        <option>Friday</option>
        <option>Saturday</option>
      </select>
    </label>

    <label for="datePicker" style="display: flex; align-items: center; gap: 10px; cursor: pointer; background: rgba(255 255 255 / 0.15); padding: 8px 12px; border-radius: 8px; border: 1.5px solid #a5b4fc;">
      <span>Select Date:</span>
      <input type="date" id="datePicker" style="
        padding: 7px 14px;
        border-radius: 6px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        color: white;
        background: #818cf8;
        min-width: 140px;
        box-shadow: 0 0 5px #6366f1a0;
      " />
    </label>
  </div>
</header>

<style>
  @media (max-width: 600px) {
    header h1 {
      font-size: 2rem !important;
    }
    header p {
      font-size: 1.4rem !important;
    }
    header #dateHeading {
      font-size: 1.1rem !important;
    }
    header .controls {
      gap: 12px !important;
      font-size: 1rem !important;
    }
    header .controls label {
      min-width: 100%;
      justify-content: center;
    }
    header .controls select,
    header .controls input[type="date"] {
      min-width: 100% !important;
    }
  }
</style>
  

  <table>
    <thead>
      <tr>
        <th>LP ID</th>
        <th>ALP ID</th>
        <th>Train No</th>
        <th>Dep Time</th>
        
      </tr>
    </thead>
    <tbody id="dutyTable"></tbody>
  </table>

<script>
  const linkFiles = ['link1.json', 'link2.json', 'link3.json', 'link4.json', 'rnlink1.json', 'rnlink2.json', 'rnlink3.json', 'ollink1.json', 'sllink1.json']; // Your JSON files
  let allCrewData = [];
  const daysArray = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

  // Initialize controls to today on page load
  const today = new Date();
  document.getElementById('datePicker').valueAsDate = today;
  document.getElementById('daySelect').value = today.toLocaleString('en-US', { weekday: 'long' });

  document.getElementById('daySelect').addEventListener('change', () => {
    syncDatePickerToDay();
    renderTableCombined();
  });
  document.getElementById('datePicker').addEventListener('change', () => {
    syncDaySelectToDate();
    renderTableCombined();
  });

  // Load all link JSON files in parallel
  Promise.all(linkFiles.map(file =>
    fetch(file).then(res => {
      if (!res.ok) throw new Error(`Failed to load ${file}`);
      return res.json();
    })
  )).then(allLinksData => {
    allCrewData = [];

    // Append link info to each crew and flatten all crew from all links
    allLinksData.forEach(linkData => {
      const linkId = linkData.linkId || 0;
      const lastUpdatedDate = new Date(linkData.lastUpdated);
      const currentCrewIndex = linkData.currentCrewIndex || 0;

      const crewWithExtras = (linkData.crew || []).map((crewMember, index) => ({
        ...crewMember,
        linkId,
        lastUpdatedDate,
        currentCrewIndex,
        crewIndex: index
      }));

      allCrewData.push(...crewWithExtras);
    });

    renderTableCombined();
  }).catch(err => {
    console.error('Error loading JSON files:', err);
    document.getElementById('dutyTable').innerHTML = `<tr><td colspan="5" style="color:red;">Error loading data</td></tr>`;
  });
function renderTableCombined() {
    if (!allCrewData.length) return;

    const selectedDate = getSelectedDate();
    const selectedDay = document.getElementById('daySelect').value;

    updateDateHeading(selectedDate);

    // Group crew by linkId
    const crewsByLink = {};
    allCrewData.forEach(crew => {
        if (!crewsByLink[crew.linkId]) crewsByLink[crew.linkId] = [];
        crewsByLink[crew.linkId].push(crew);
    });

    const dutyRows = [];

    // For each link group, apply rotation and collect duties
    Object.values(crewsByLink).forEach(crewList => {
        if (!crewList.length) return;

        const { linkId, lastUpdatedDate } = crewList[0];

        // Calculate weeks passed
        const diffMs = selectedDate.getTime() - lastUpdatedDate.getTime();
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        const weeksPassed = Math.floor(diffDays / 7);

        // Duties fixed per row (index)
        const dutiesPerRow = crewList.map(crew => crew.duties);

        for (let rowIndex = 0; rowIndex < crewList.length; rowIndex++) {
            // Rotate crew position for this week
            const crewIndex = (rowIndex - weeksPassed + crewList.length) % crewList.length;
            const crew = crewList[crewIndex];

            // Duty fixed by row index
            const dutyForRow = dutiesPerRow[rowIndex][selectedDay] || '';

            let trainNo = '';
            let depTime = '';

            if (typeof dutyForRow === 'object' && dutyForRow.outgoing) {
                trainNo = dutyForRow.incoming?.trim()
                    ? `${dutyForRow.outgoing}/${dutyForRow.incoming}`
                    : dutyForRow.outgoing;
                depTime = dutyForRow.depTime || '';
            } else if (typeof dutyForRow === 'string') {
                trainNo = dutyForRow.toUpperCase() === 'REST' ? 'REST' : dutyForRow;
            }

            dutyRows.push({
                crewLPId: crew.crewLPId,
                crewALPId: crew.crewALPId,
                trainNo,
                depTime,
                linkNumber: linkId,
                isRest: trainNo.toUpperCase() === 'REST',
            });
        }
    });

    // âœ… Keep only rows with a valid train number (exclude empty and REST)
    const filteredRows = dutyRows.filter(row =>
        row.trainNo && row.trainNo.trim() !== '' && row.trainNo.toUpperCase() !== 'REST'
    );

    // Sort duties by depTime
    filteredRows.sort((a, b) => {
        if (a.depTime && b.depTime) return timeStringToMinutes(a.depTime) - timeStringToMinutes(b.depTime);
        if (a.depTime && !b.depTime) return -1;
        if (!a.depTime && b.depTime) return 1;
        return 0;
    });

    // Render filtered table rows
    const tbody = document.getElementById('dutyTable');
    tbody.innerHTML = '';

    filteredRows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.crewLPId}</td>
            <td>${row.crewALPId}</td>
            <td>${row.trainNo}</td>
            <td>${row.depTime || ''}</td>
            <td>${row.linkNumber}</td>
        `;
        tbody.appendChild(tr);
    });
}



  function timeStringToMinutes(timeStr) {
    if (!timeStr) return Infinity;
    const [h, m] = timeStr.split(':').map(Number);
    return h * 60 + m;
  }

  function getSelectedDate() {
    const dateInput = document.getElementById('datePicker').value;
    return dateInput ? new Date(dateInput) : new Date();
  }

  function updateDateHeading(date) {
    const formattedDate = date.toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
    });
    const dayName = date.toLocaleString('en-US', { weekday: 'long' });
    document.getElementById('dateHeading').textContent = `${dayName}, ${formattedDate}`;
  }

  function syncDatePickerToDay() {
    const selectedDay = document.getElementById('daySelect').value;
    const today = new Date();
    const todayIndex = today.getDay();
    const targetIndex = daysArray.indexOf(selectedDay);
    let dayDiff = targetIndex - todayIndex;
    if (dayDiff < 0) dayDiff += 7;
    const targetDate = new Date();
    targetDate.setDate(today.getDate() + dayDiff);
    document.getElementById('datePicker').valueAsDate = targetDate;
  }

  function syncDaySelectToDate() {
    const selectedDate = getSelectedDate();
    const dayName = selectedDate.toLocaleString('en-US', { weekday: 'long' });
    document.getElementById('daySelect').value = dayName;
  }
</script>
</body>
</html>
