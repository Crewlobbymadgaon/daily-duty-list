<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>LP/ALP Duty Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    select, input[type="date"] { padding: 5px; margin-bottom: 10px; }
    .rest { background-color: #ffe0e0; }
    #dateHeading { font-size: 18px; margin-bottom: 10px; font-weight: bold; }
    .controls { margin-bottom: 15px; }
  </style>
</head>
<body>
  <h2>LP/ALP Duty Viewer</h2>
  <div id="dateHeading"></div>

  <div class="controls">
    <label for="daySelect">Select Day: </label>
    <select id="daySelect">
      <option>Sunday</option>
      <option>Monday</option>
      <option>Tuesday</option>
      <option>Wednesday</option>
      <option>Thursday</option>
      <option>Friday</option>
      <option>Saturday</option>
    </select>

    &nbsp;&nbsp;

    <label for="datePicker">Select Date: </label>
    <input type="date" id="datePicker" />
  </div>

  <table>
    <thead>
      <tr>
        <th>LP ID</th>
        <th>ALP ID</th>
        <th>Train No</th>
        <th>Dep Time</th>
        <th>Link Number</th>
      </tr>
    </thead>
    <tbody id="dutyTable"></tbody>
  </table>

 <script>
  const linkFiles = ['link1.json', 'link2.json'];
  let allCrewData = [];
  const daysArray = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

  // Initialize date controls to today on page load
  const today = new Date();
  document.getElementById('datePicker').valueAsDate = today;
  const todayDayName = today.toLocaleString('en-US', { weekday: 'long' });
  document.getElementById('daySelect').value = todayDayName;

  document.getElementById('daySelect').addEventListener('change', () => {
    syncDatePickerToDay();
    renderTableCombined();
  });
  document.getElementById('datePicker').addEventListener('change', () => {
    syncDaySelectToDate();
    renderTableCombined();
  });

  // Load all link JSON files in parallel
  Promise.all(linkFiles.map(f => fetch(f).then(r => r.json())))
    .then(allLinksData => {
      allCrewData = [];
      allLinksData.forEach(linkData => {
        const linkId = linkData.linkId || 0;
        const lastUpdatedDate = new Date(linkData.lastUpdated);
        const currentCrewIndex = linkData.currentCrewIndex || 0;

        // Add linkId, lastUpdatedDate, currentCrewIndex to each crew member for later use
        const crewWithExtras = linkData.crew.map((c, index) => ({
          ...c,
          linkId,
          lastUpdatedDate,
          currentCrewIndex,
          crewIndex: index, // position in this link's crew list
        }));

        allCrewData.push(...crewWithExtras);
      });

      renderTableCombined();
    })
    .catch(err => console.error('Error loading JSON files:', err));

  function renderTableCombined() {
    if (!allCrewData.length) return;

    const selectedDate = getSelectedDate();
    const selectedDay = document.getElementById('daySelect').value;

    updateDateHeading(selectedDate);

    // Group allCrewData by linkId first
    const crewsByLink = {};
    allCrewData.forEach(c => {
      if (!crewsByLink[c.linkId]) crewsByLink[c.linkId] = [];
      crewsByLink[c.linkId].push(c);
    });

    // Build combined duty rows array
    const dutyRows = [];

    Object.values(crewsByLink).forEach(crewList => {
      if (crewList.length === 0) return;

      // All share same linkId, lastUpdatedDate, currentCrewIndex
      const { linkId, lastUpdatedDate, currentCrewIndex } = crewList[0];

      // Calculate weeks passed for this link
      const diffMs = selectedDate.getTime() - lastUpdatedDate.getTime();
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const weeksPassed = Math.floor(diffDays / 7);

      // Rotate crew for this week
      for (let rowIndex = 0; rowIndex < crewList.length; rowIndex++) {
        const crewIndex = (rowIndex - weeksPassed + crewList.length) % crewList.length;
        const crew = crewList[crewIndex];

        // Use duties from rotated crew (crew), not fixed rowIndex
        const dutyForRow = crew.duties[selectedDay] || '';

        let trainNo = '';
        let depTime = null;

        if (typeof dutyForRow === 'object' && dutyForRow.outgoing) {
          trainNo = `${dutyForRow.outgoing}/${dutyForRow.incoming || ''}`;
          depTime = dutyForRow.depTime || null;
        } else if (typeof dutyForRow === 'string') {
          trainNo = dutyForRow.toUpperCase() === 'REST' ? 'REST' : dutyForRow;
        }

        dutyRows.push({
          crewLPId: crew.crewLPId,
          crewALPId: crew.crewALPId,
          trainNo,
          depTime,
          linkNumber: linkId,
          isRest: trainNo === 'REST',
        });
      }
    });

    // Sort all duty rows by depTime ascending, REST last
    dutyRows.sort((a, b) => {
      if (a.isRest && !b.isRest) return 1;
      if (!a.isRest && b.isRest) return -1;
      if (a.depTime && b.depTime) return timeStringToMinutes(a.depTime) - timeStringToMinutes(b.depTime);
      if (a.depTime && !b.depTime) return -1;
      if (!a.depTime && b.depTime) return 1;
      return 0;
    });

    const tbody = document.getElementById('dutyTable');
    tbody.innerHTML = '';

    dutyRows.forEach(row => {
      const tr = document.createElement('tr');
      if (row.isRest) tr.classList.add('rest');
      tr.innerHTML = `
        <td>${row.crewLPId}</td>
        <td>${row.crewALPId}</td>
        <td>${row.trainNo}</td>
        <td>${row.depTime || ''}</td>
        <td>${row.linkNumber}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Helper: Convert HH:MM string to minutes number for sorting
  function timeStringToMinutes(timeStr) {
    if (!timeStr) return Infinity;
    const [h, m] = timeStr.split(':').map(Number);
    return h * 60 + m;
  }

  function getSelectedDate() {
    const dateInput = document.getElementById('datePicker').value;
    return dateInput ? new Date(dateInput) : new Date();
  }

  function updateDateHeading(date) {
    const formattedDate = date.toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
    });
    const dayName = date.toLocaleString('en-US', { weekday: 'long' });
    document.getElementById('dateHeading').textContent = `${dayName}, ${formattedDate}`;
  }

  function syncDatePickerToDay() {
    const selectedDay = document.getElementById('daySelect').value;
    const today = new Date();
    const todayIndex = today.getDay();
    const targetIndex = daysArray.indexOf(selectedDay);
    let dayDiff = targetIndex - todayIndex;
    if (dayDiff < 0) dayDiff += 7;
    const targetDate = new Date();
    targetDate.setDate(today.getDate() + dayDiff);
    document.getElementById('datePicker').valueAsDate = targetDate;
  }

  function syncDaySelectToDate() {
    const selectedDate = getSelectedDate();
    const dayName = selectedDate.toLocaleString('en-US', { weekday: 'long' });
    document.getElementById('daySelect').value = dayName;
  }
</script>


</body>
</html>
