<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MAO Link</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="manifest" href="/daily-duty-list/manifest.json">
<link rel="apple-touch-icon" href="/daily-duty-list/icons/icon-192.png">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-title" content="Duty Table">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root{
  --bg:#f4f7fb; --card:#fff; --muted:#6b7280; --accent:#0f172a; --accent-2:#2563eb;
  --radius:12px; --divider:#1f6feb; --border:#cdd4e1; --pill-border: rgba(0,0,0,0.08);
  --row-height:64px; --train-col-width:120px; --pill-space:36px; --cell-padding-x:10px;
  --train-slot-height:24px; --train-gap:6px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--accent);-webkit-font-smoothing:antialiased}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 24px rgba(15,23,42,0.06);overflow:hidden}
.headerArea{position:sticky; top:0;background:var(--card);padding:14px 16px;border-bottom:1px solid rgba(0,0,0,0.04);z-index:60;display:flex;flex-direction:column;align-items:center;gap:6px;}
.headerArea h1{margin:0;font-size:1.25rem;font-weight:700;text-align:center}
.headerArea .sub{font-size:0.9rem;color:var(--muted);text-align:center}
.headerArea #dateHeading{font-weight:600;color:var(--accent-2);text-align:center}
.headerArea #loginStatus{font-size:0.95rem;color:var(--muted);margin-top:4px;width:100%;text-align:center;display:block}
.controls{position:sticky;top:0;background:var(--card);z-index:55;display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;border-bottom:1px solid rgba(0,0,0,0.03)}
.nav-btn{background:transparent;border:1px solid rgba(15,23,42,0.06);width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.date-icon-btn{display:inline-flex;align-items:center;justify-content:center;background:var(--accent-2);color:#fff;border:none;border-radius:8px;min-width:44px;height:36px;padding:0 10px;cursor:pointer}
input[type="date"].native-date{position:absolute;left:-9999px}
.tableWrap{max-height:calc(100vh - 112px);overflow:auto;border-radius:0;background:#fff;padding:6px;position:relative}
table{width:100%;border-collapse:collapse;min-width:640px;table-layout:fixed;border:1px solid var(--border)}
thead th{background:var(--card);padding:10px 12px;text-align:center;color:var(--muted);font-weight:700;border-bottom:1px solid var(--border);border-top:1px solid rgba(0,0,0,0.04);position:sticky;z-index:70;top:0;box-sizing:border-box}
tbody td{padding:0;border:1px solid var(--border);font-size:0.95rem;color:var(--accent);vertical-align:middle;text-align:center;overflow:visible;position:relative;height:var(--row-height);}
tbody tr:nth-child(odd){background:#fbfdff}
.no-data{text-align:center;color:var(--muted);padding:14px}
.lp-cell{ position:relative; }
.link-pill{
  position:absolute; top:6px; left:8px; display:inline-flex; align-items:center; justify-content:center;
  padding:4px 8px; border-radius:999px; font-weight:700; font-size:0.72rem; text-transform:uppercase; letter-spacing:0.3px;
  background:transparent; border:1.5px solid var(--pill-border); color:var(--muted); pointer-events:none; z-index:60; min-width:46px;
}
.train-cell{ position:relative; padding-top:var(--pill-space); box-sizing:border-box; }
.dep-pill{ position:absolute; top:6px; right:8px; background:transparent; border:1.5px solid var(--pill-border); padding:4px 8px; border-radius:999px; font-size:0.72rem; font-weight:700; color:var(--muted); pointer-events:none; z-index:60; }
.train-stack{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:var(--train-gap); padding:2px 4px; max-width:100%; box-sizing:border-box; min-height: calc( (var(--train-slot-height) * 2) + var(--train-gap) ); }
.train-slot{ height:var(--train-slot-height); display:flex; align-items:center; justify-content:center; width:100%; box-sizing:border-box; }
.train-number{ font-weight:700; font-size:0.9rem; line-height:1; text-align:center; max-width:calc(var(--train-col-width) - 16px); white-space:normal; word-break:break-word; }
.train-number.nowrap{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.train-divider{ width:60%; height:2px; background:var(--divider); border-radius:2px; margin:0; opacity:1; }
.editable{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; padding:6px 8px; box-sizing:border-box; text-align:center; font-weight:700; border-radius:6px; outline:none; cursor:text; }
.editable:focus{box-shadow:0 0 0 3px rgba(37,99,235,0.08);border:1px dashed rgba(37,99,235,0.15)}
.editable[contenteditable="false"]{background:transparent;cursor:not-allowed;color:rgba(0,0,0,0.6);pointer-events:none}
#adminSignInBtn{position:fixed;top:10px;right:10px;z-index:200;background:#111;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
.toast{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .18s}
.toast.show{opacity:1;transform:translateY(0)}
.ownerTag{font-size:0.7rem;color:#fff;background:#2563eb;padding:4px 6px;border-radius:6px;display:inline-block;margin-left:6px}

/* visually hide Link No column on desktop */
table th:nth-child(5), table td:nth-child(5){ display: none; }

@media (max-width:640px){
  :root{ --train-col-width:110px; --row-height:60px; --pill-space:32px; --train-slot-height:20px; --train-gap:4px; }
  table{min-width:0;table-layout:auto}
  thead th:nth-child(4),thead th:nth-child(5),tbody td:nth-child(4),tbody td:nth-child(5){display:none}
  thead th,tbody td{padding:6px}
  .train-number{font-size:0.86rem; max-width:calc(var(--train-col-width) - 16px)}
  .link-pill{font-size:0.64rem;padding:3px 6px;left:6px;top:6px}
  .dep-pill{font-size:0.64rem;padding:3px 6px;right:6px;top:6px}
  .cell-inner{padding: calc(var(--pill-space) / 10) var(--cell-padding-x)}
}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="headerArea" role="banner" aria-label="Header">
        <h1>LP/ALP Duty Table</h1>
        <div class="sub">Madgaon Lobby</div>
        <div id="dateHeading">Loading dateâ€¦</div>
        <div id="loginStatus" aria-live="polite"></div>
      </div>

      <div class="controls" role="toolbar" aria-label="Date controls">
        <button id="prevDay" class="nav-btn" title="Previous day">â—€</button>
        <button id="dateBtn" class="date-icon-btn" title="Pick a date">ðŸ“…</button>
        <input id="datePicker" class="native-date" type="date" />
        <button id="nextDay" class="nav-btn" title="Next day">â–¶</button>
      </div>

      <div class="tableWrap" aria-live="polite">
        <table id="mainTable" aria-describedby="dateHeading">
          <thead>
            <tr>
              <th style="text-align:center">LP</th>
              <th style="text-align:center">ALP</th>
              <th style="text-align:center">Train No:</th>
              <th style="text-align:center">Dep</th>
              <th style="text-align:center">Link No</th>
            </tr>
          </thead>
          <tbody id="dutyTable">
            <tr><td colspan="5" class="no-data">Loading data...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <button id="adminSignInBtn" title="Admin sign-in">Admin</button>
  <button id="installBtn" class="date-icon-btn" style="display:none; margin-left:8px;">Install</button>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ---------- CONFIG ---------- */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyA39vWi_90CUyj0davz4XAXqMey1aNM6FU",
  authDomain: "crewdutytable.firebaseapp.com",
  databaseURL: "https://crewdutytable-default-rtdb.firebaseio.com",
  projectId: "crewdutytable",
  storageBucket: "crewdutytable.appspot.com",
  messagingSenderId: "190634478615",
  appId: "1:190634478615:web:28e998325f69fb8bf36052"
};

const linkFiles = [
  'link1.json','link2.json','link3.json','link4.json',
  'rnlink1.json','rnlink2.json','rnlink3.json','rnlink4.json',
  'ollink1.json','sllink1.json'
];

const LS_KEY = 'lp_alp_edits_owner_v1';
const POLL_MS = 15000;

let localEdits = loadLocalEdits();
let allCrewData = [];
let selectedDate = new Date();
let firebaseApp = null, firebaseAuth = null, firebaseDb = null;
let currentUser = null, isAdmin = false;

let latestFbEdits = null;
let realtimeListenerAttached = false;
let pollingIntervalId = null;

const writeDebounce = {};
const WRITE_DEBOUNCE_MS = 700;

/* ---------- DOM refs ---------- */
const dutyTable = document.getElementById('dutyTable');
const mainTable = document.getElementById('mainTable');
const tableWrap = document.querySelector('.tableWrap');
const dateBtn = document.getElementById('dateBtn');
const datePicker = document.getElementById('datePicker');
const prevBtn = document.getElementById('prevDay');
const nextBtn = document.getElementById('nextDay');
const dateHeading = document.getElementById('dateHeading');
const toast = document.getElementById('toast');
const adminSignInBtn = document.getElementById('adminSignInBtn');
const loginStatus = document.getElementById('loginStatus');

/* ---------- utilities ---------- */
function showToast(msg, t=1400){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>toast.classList.remove('show'), t); }
function loadLocalEdits(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }catch(e){ return {}; } }
function saveLocalEdits(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(localEdits)); }catch(e){} }
function loadLocalUser(){ try{ return JSON.parse(localStorage.getItem('lp_user_v_owner')||'null'); }catch(e){return null} }
function saveLocalUser(u){ try{ localStorage.setItem('lp_user_v_owner',JSON.stringify(u)); }catch(e){} }
function createLocalUser(){ const uid = 'local-'+Math.random().toString(36).slice(2,9); const u = { uid, displayName: `Viewer-${uid.slice(-4)}`, local:true }; saveLocalUser(u); return u; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function placeCaretAtEnd(el){ try{ el.focus(); const range=document.createRange(); range.selectNodeContents(el); range.collapse(false); const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range);}catch(e){} }
function sanitizeName(s){ const x = (s||"").replace(/\s+/g," ").trim(); return x.slice(0, 40); }
function dateOnlyISO(d){ if(!d) return ''; if(d instanceof Date) return d.toISOString().slice(0,10); try { return (new Date(d)).toISOString().slice(0,10); } catch(e){ return String(d).slice(0,10); } }

/* ---------- revision helpers ---------- */
function normalizeToRevisions(editObj){
  if(!editObj || typeof editObj !== 'object') return {};
  if(editObj._revisions && typeof editObj._revisions === 'object') return Object.assign({}, editObj);
  const res = Object.assign({}, editObj);
  const eff = editObj._effectiveFrom || editObj._effective_from || null;
  const revs = {};
  const fields = {};
  Object.keys(editObj).forEach(k=>{
    if(k.startsWith('_')) return;
    fields[k] = editObj[k];
    delete res[k];
  });
  if(Object.keys(fields).length){
    const dateKey = eff || '1970-01-01';
    revs[dateKey] = Object.assign({}, fields);
    revs[dateKey]._updatedBy = editObj._updatedBy || editObj._updated_by || null;
    revs[dateKey]._updatedByName = editObj._updatedByName || editObj._updated_by_name || null;
    revs[dateKey]._updatedAt = editObj._updatedAt || editObj._updated_at || new Date().toISOString();
    res._revisions = revs;
  }
  return res;
}
function getFieldFromEdit(editObj, field){
  if(!editObj) return null;
  const revs = editObj._revisions;
  const sel = dateOnlyISO(selectedDate);
  if(revs && typeof revs === 'object'){
    const validDates = Object.keys(revs).filter(d=>typeof d === 'string' && d <= sel).sort();
    if(validDates.length){
      for(let i=validDates.length-1;i>=0;i--){
        const candidate = revs[validDates[i]];
        if(candidate && candidate[field] && String(candidate[field]).trim()) return String(candidate[field]).trim();
      }
    }
  }
  if(editObj[field] && String(editObj[field]).trim()){
    const eff = editObj._effectiveFrom || editObj._effective_from || null;
    if(!eff) return String(editObj[field]).trim();
    if(eff && eff <= sel) return String(editObj[field]).trim();
  }
  return null;
}

/* ---------- reconcile ---------- */
function reconcileLocalWithFirebase(fbEdits){
  if(!fbEdits || typeof fbEdits !== 'object') return false;
  let changed = false;
  Object.keys(localEdits || {}).forEach(linkId=>{
    const localLink = localEdits[linkId] || {};
    Object.keys(localLink).forEach(idxKey=>{
      const localObj = localLink[idxKey];
      const fbObjRaw = fbEdits[linkId] && fbEdits[linkId][idxKey];
      if(!fbObjRaw){
        delete localEdits[linkId][idxKey];
        changed = true;
      } else {
        const fbObj = normalizeToRevisions(fbObjRaw);
        if(fbObj._revisions && Object.keys(fbObj._revisions).length){
          localEdits[linkId][idxKey] = fbObj;
          changed = true;
        } else {
          const localNorm = normalizeToRevisions(localObj);
          localNorm._revisions = localNorm._revisions || {};
          if(fbObj._revisions){
            Object.keys(fbObj._revisions).forEach(d=>{
              localNorm._revisions[d] = localNorm._revisions[d] || fbObj._revisions[d];
            });
            localEdits[linkId][idxKey] = localNorm;
            changed = true;
          }
        }
      }
    });
    if(localEdits[linkId] && Object.keys(localEdits[linkId]).length === 0){
      delete localEdits[linkId];
      changed = true;
    }
  });
  if(changed) saveLocalEdits();
  return changed;
}

/* ---------- firebase realtime & polling ---------- */
function attachRealtimeEditsListener(){
  if(!firebaseDb || realtimeListenerAttached) return;
  try{
    realtimeListenerAttached = true;
    firebaseDb.ref('/edits').on('value', snap=>{
      try{
        latestFbEdits = snap.val() || {};
        reconcileLocalWithFirebase(latestFbEdits);
        renderCombinedDuties();
      }catch(e){
        console.warn('Realtime handler error', e);
      }
    });
    if(pollingIntervalId){ clearInterval(pollingIntervalId); pollingIntervalId = null; }
  }catch(e){ console.warn('attachRealtimeEditsListener failed', e); }
}

function startPollingFallback(){
  if(pollingIntervalId || !firebaseDb || realtimeListenerAttached) return;
  pollingIntervalId = setInterval(async ()=>{
    try{
      const snap = await firebaseDb.ref('/edits').once('value');
      const fb = snap.val() || {};
      if(JSON.stringify(fb) !== JSON.stringify(latestFbEdits)){
        latestFbEdits = fb;
        reconcileLocalWithFirebase(latestFbEdits);
        renderCombinedDuties();
      }
    }catch(e){ /* ignore network errors */ }
  }, POLL_MS);
}

/* ---------- deterministic mapper ---------- */
function getShortLinkLabel(linkId) {
  if (!linkId) return '';
  const id = String(linkId).toLowerCase().trim();

  let m = id.match(/^link(\d+)$/); if (m) return `MAO${m[1]}`;
  m = id.match(/^rnlink(\d+)$/); if (m) return `RN${m[1]}`;
  m = id.match(/^sllink(\d+)$/); if (m) return `SL${m[1]}`;
  m = id.match(/^ollink(\d+)$/); if (m) return `OL${m[1]}`;

  const digits = id.match(/(\d+)/);
  if (digits) {
    const d = digits[1];
    if (id.includes('rn')) return `RN${d}`;
    if (id.includes('ol')) return `OL${d}`;
    if (id.includes('sl')) return `SL${d}`;
    return `MAO${d}`;
  }
  return String(linkId).toUpperCase();
}

function formatTrainToken(token){
  if(!token) return '';
  const cleaned = token.toString().trim();
  if(/^\d{5}$/.test(cleaned)){
    return `<span class="train-number nowrap">${escapeHtml(cleaned)}</span>`;
  }
  const withBreaks = escapeHtml(cleaned).replace(/\//g, '/<wbr>');
  return `<span class="train-number">${withBreaks}</span>`;
}

/* ---------- layout helpers ---------- */
function setTableWrapPaddingAndHeader(){
  const header = document.querySelector('.headerArea');
  const controls = document.querySelector('.controls');
  if(!header || !controls || !tableWrap) return;
  const headerRect = header.getBoundingClientRect();
  const controlsRect = controls.getBoundingClientRect();
  const wrapRect = tableWrap.getBoundingClientRect();
  let numericTop = Math.round(controlsRect.bottom - wrapRect.top);
  numericTop = Math.max(0, numericTop);
  tableWrap.style.paddingTop = numericTop + 'px';
  tableWrap.style.boxSizing = 'border-box';
  document.querySelectorAll('thead th').forEach(th => { th.style.top = '0px'; });
  const reserved = Math.round(headerRect.height + controlsRect.height) + 28;
  tableWrap.style.maxHeight = Math.max(120, window.innerHeight - reserved) + 'px';
  alignHeaderWidths();
}
function alignHeaderWidths(){
  const thead = mainTable.querySelector('thead');
  if(!thead) return;
  const ths = Array.from(thead.querySelectorAll('th'));
  const firstRow = mainTable.querySelector('tbody tr');
  let widths = [];
  if(firstRow){
    const tds = Array.from(firstRow.querySelectorAll('td'));
    if(tds.length === ths.length){
      widths = tds.map(td => Math.round(td.getBoundingClientRect().width) || Math.round(ths[0].getBoundingClientRect().width));
    }
  }
  if(widths.length !== ths.length){
    widths = ths.map(th => Math.round(th.getBoundingClientRect().width) || 80);
  }
  ths.forEach((th,i)=>{ const w = widths[i] || 60; th.style.width = w+'px'; th.style.minWidth = w+'px'; th.style.maxWidth = w+'px'; th.style.boxSizing='border-box'; });
  const mainWidth = Math.round(mainTable.getBoundingClientRect().width);
  mainTable.style.tableLayout = 'fixed';
  if(mainWidth) mainTable.style.width = mainWidth + 'px';
}

/* ---------- date controls ---------- */
dateBtn.addEventListener('click', ()=>{ datePicker.focus(); datePicker.click(); });
datePicker.addEventListener('change', ()=>{ selectedDate = datePicker.value ? new Date(datePicker.value+'T00:00:00') : new Date(); setSelectedDate(selectedDate); renderCombinedDuties(); });
prevBtn.addEventListener('click', ()=> changeDate(-1));
nextBtn.addEventListener('click', ()=> changeDate(1));
function changeDate(offset){ const d=new Date(selectedDate.getTime()); d.setDate(d.getDate()+offset); setSelectedDate(d); renderCombinedDuties(); }
function setSelectedDate(d){ selectedDate = d||new Date(); const yyyy=selectedDate.getFullYear(), mm=String(selectedDate.getMonth()+1).padStart(2,'0'), dd=String(selectedDate.getDate()).padStart(2,'0'); datePicker.value = `${yyyy}-${mm}-${dd}`; dateHeading.textContent = `${selectedDate.toLocaleString('en-US',{weekday:'long'})}, ${selectedDate.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`; }

/* ---------- load link files (normalizes linkId) ---------- */
async function loadAllLinks(){
  dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>`;
  const fetches = linkFiles.map(async (f, idx) => {
    try {
      const path = String(f);
      const resp = await fetch(path, { cache: 'no-cache' });
      if (!resp.ok){
        const body = await resp.text().catch(()=>'<no body>');
        console.error(`Fetch failed for ${path}:`, resp.status, resp.statusText, body);
        return { __error:true, file:path, status:resp.status, statusText:resp.statusText, body };
      }
      try {
        const json = await resp.json();
        return { ok:true, json, file:path, idx };
      } catch(parseErr){
        const txt = await resp.text().catch(()=>'<no body>');
        console.error(`JSON parse failed for ${path}:`, parseErr, txt);
        return { __error:true, file:path, parseErr: (parseErr && parseErr.message), body: txt };
      }
    } catch(err){
      console.error(`Network fetch error for ${f}:`, err && err.message ? err.message : err);
      return { __error:true, file: String(f), err: (err && err.message) || String(err) };
    }
  });

  const results = await Promise.all(fetches);
  allCrewData = [];

  const anySuccess = results.some(r => r && r.ok && r.json && Array.isArray(r.json.crew) && r.json.crew.length>0);

  if(!anySuccess){
    dutyTable.innerHTML = '';
    const errors = results.map(res => {
      if(!res) return 'No response';
      if(res.__error){
        if(res.status) return `${res.file} â€” ${res.status} ${res.statusText}`;
        if(res.parseErr) return `${res.file} â€” parse error: ${res.parseErr}`;
        if(res.err) return `${res.file} â€” network error: ${res.err}`;
        return `${res.file} â€” unknown error`;
      }
      if(!Array.isArray(res.json.crew)) return `${res.file} â€” missing crew array`;
      return null;
    }).filter(Boolean);
    const msg = errors.length ? errors.join(' Â· ') : 'No link files with crew data found';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5" class="no-data">Failed to load link files: ${escapeHtml(msg)}</td>`;
    dutyTable.appendChild(tr);
    setTableWrapPaddingAndHeader();
    console.warn('loadAllLinks: problems', results);
    return;
  }

  results.forEach((res, idx) => {
    if(!res || !res.ok || !res.json) return;
    const linkData = res.json;
    const rawFallback = (typeof linkFiles[res.idx] === 'string') ? String(linkFiles[res.idx]).replace(/\.json$/i,'') : `file#${idx+1}`;
    let rawLinkId = (linkData.linkId && String(linkData.linkId)) || rawFallback || '';
    rawLinkId = rawLinkId.replace(/^.*[\/\\]/, '').replace(/\.json$/i, '').trim().toLowerCase();

    rawLinkId = rawLinkId
      .replace(/^l(\d+)$/,'link$1')
      .replace(/^link[-_]?(\d+)$/,'link$1')
      .replace(/^mao[-_]?(\d+)$/,'link$1')
      .replace(/^rn[-_]?(\d+)$/,'rnlink$1')
      .replace(/^rn-?link[-_]?(\d+)$/,'rnlink$1')
      .replace(/^ol[-_]?(\d+)$/,'ollink$1')
      .replace(/^s?l[-_]?(\d+)$/,'sllink$1')
      .replace(/[^a-z0-9]/g,'');

    if(!rawLinkId) rawLinkId = rawFallback.replace(/[^a-z0-9]/g,'');

    const linkId = rawLinkId;
    const lastUpdated = linkData.lastUpdated ? new Date(linkData.lastUpdated) : new Date();
    const crewArr = Array.isArray(linkData.crew) ? linkData.crew : [];
    const friendly = linkData.label || linkData.linkName || linkData.displayName || linkData.name || null;

    crewArr.forEach((crew, crewIndex) => {
      allCrewData.push({
        ...crew,
        linkId,
        linkIdRaw: linkData.linkId || rawFallback,
        lastUpdatedDate: lastUpdated,
        crewIndex,
        friendlyLabel: friendly
      });
    });
  });

  await renderCombinedDuties();
}

/* ---------- render duties (uses linkIdRaw to decide pill label) ---------- */
async function renderCombinedDuties(){
  if(!allCrewData.length){ dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No data available</td></tr>`; setTableWrapPaddingAndHeader(); return; }
  const weekday = selectedDate.toLocaleString('en-US',{weekday:'long'});

  let fbEdits = {};
  if(latestFbEdits !== null){
    fbEdits = latestFbEdits;
  } else if(firebaseDb){
    try{
      const snap = await firebaseDb.ref('/edits').once('value');
      fbEdits = snap.val() || {};
      latestFbEdits = fbEdits;
      reconcileLocalWithFirebase(fbEdits);
    }catch(e){
      fbEdits = {};
      console.warn('fbEdits load failed', e);
    }
  }

  const crewsByLink = allCrewData.reduce((acc,crew)=>{ (acc[crew.linkId]=acc[crew.linkId]||[]).push(crew); return acc; }, {});
  const rows = [];

  Object.values(crewsByLink).forEach(crewList=>{
    if(!crewList.length) return;
    const lastUpdatedDate = crewList[0].lastUpdatedDate ? new Date(crewList[0].lastUpdatedDate) : new Date();
    const diffDays = Math.floor((selectedDate.getTime()-lastUpdatedDate.getTime())/(1000*60*60*24));
    const weeksPassed = Math.floor(diffDays/7);
    const dutiesPerRow = crewList.map(c=>c.duties||{});
    for(let rowIndex=0; rowIndex<crewList.length; rowIndex++){
      const crewIndex = ((rowIndex - weeksPassed) % crewList.length + crewList.length) % crewList.length;
      const crew = crewList[crewIndex];
      const dutyForRow = dutiesPerRow[rowIndex][weekday] ?? '';
      let outgoing='', incoming='', depTime='';
      if(dutyForRow && typeof dutyForRow === 'object' && (dutyForRow.outgoing||dutyForRow.incoming)){
        outgoing = (dutyForRow.outgoing||'').toString().trim();
        incoming = (dutyForRow.incoming||'').toString().trim();
        depTime = (dutyForRow.depTime||'').toString().trim();
      } else if(typeof dutyForRow === 'string') outgoing = dutyForRow.trim();
      const combined = (incoming ? `${outgoing}/${incoming}` : outgoing).toUpperCase();
      if(!combined || combined === 'REST') continue;
      const linkId = crew.linkId;

      const localRaw = (localEdits[linkId] && localEdits[linkId][crew.crewIndex]) || null;
      const fbRaw = (fbEdits[linkId] && fbEdits[linkId][crew.crewIndex]) || null;
      const local = localRaw ? normalizeToRevisions(localRaw) : null;
      const fb = fbRaw ? normalizeToRevisions(fbRaw) : null;

      const ownerUid = (fb && (fb._updatedBy)) || (local && local._updatedBy) || null;
      const ownerName = (fb && (fb._updatedByName)) || (local && local._updatedByName) || null;

      const localLP = getFieldFromEdit(local, 'crewLPName');
      const fbLP = getFieldFromEdit(fb, 'crewLPName');
      const lpName = localLP || fbLP || (crew.friendlyLabel ? crew.friendlyLabel : getShortLinkLabel(crew.linkId));

      const localALP = getFieldFromEdit(local, 'crewALPName');
      const fbALP = getFieldFromEdit(fb, 'crewALPName');
      const alpName = localALP || fbALP || (crew.friendlyLabel ? crew.friendlyLabel : getShortLinkLabel(crew.linkId));

      rows.push({ depTime, outgoing, incoming, lpName, alpName, link: linkId, crewIndex: crew.crewIndex, ownerUid, ownerName });
    }
  });

  function tmin(t){ if(!t) return Infinity; const m = t.match(/^(\d{1,2}):(\d{2})$/); return m ? (+m[1])*60 + (+m[2]) : Infinity; }
  rows.sort((a,b)=> tmin(a.depTime) - tmin(b.depTime));

  if(!rows.length){ dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No duties for ${weekday}</td></tr>`; setTableWrapPaddingAndHeader(); return; }

  dutyTable.innerHTML = '';
  rows.forEach(r=>{
    const outHtml = formatTrainToken(r.outgoing || '');
    const inHtml  = r.incoming ? formatTrainToken(r.incoming) : '';
    let trainInner = '';
    if(inHtml){
      trainInner = `<div class="train-stack"><div class="train-slot">${outHtml}</div><div class="train-divider" aria-hidden="true"></div><div class="train-slot">${inHtml}</div></div>`;
    } else {
      trainInner = `<div class="train-stack"><div class="train-slot">${outHtml}</div><div class="train-divider" style="opacity:0" aria-hidden="true"></div><div class="train-slot">&nbsp;</div></div>`;
    }

    const tr = document.createElement('tr');

    const mayEditLP = !!isAdmin || (currentUser && currentUser.uid && r.ownerUid && currentUser.uid === r.ownerUid);
    const mayEditALP = !!isAdmin || (currentUser && currentUser.uid && r.ownerUid && currentUser.uid === r.ownerUid);
    const ownerTag = (r.ownerName) ? `<span class="ownerTag">${escapeHtml(r.ownerName)}</span>` : '';

    // ----- prefer linkIdRaw when deciding label (ensures RN/OL/SL show correctly) -----
    let linkLabel = '';
    (function(){
      try{
        const sample = Array.isArray(allCrewData) ? allCrewData.find(x => String(x.linkId) === String(r.link)) : null;
        let raw = sample && sample.linkIdRaw ? String(sample.linkIdRaw).toLowerCase() : null;
        if(raw) raw = raw.replace(/^.*[\/\\]/, '').replace(/\.json$/i, '').trim();
        let chosen = raw || String(r.link || '').toLowerCase();
        chosen = chosen.replace(/\.json$/i,'').trim();
        const computed = (typeof getShortLinkLabel === 'function') ? getShortLinkLabel(chosen) : String(chosen).toUpperCase();
        linkLabel = escapeHtml(computed || getShortLinkLabel(r.link) || r.link || '');
      }catch(e){
        linkLabel = escapeHtml(getShortLinkLabel(r.link) || r.link || '');
      }
    })();
    // -------------------------------------------------------------------------------

    const lpCell = `
      <td class="lp-cell">
        <div class="link-pill">${linkLabel}</div>
        <div class="cell-inner">
          <div class="editable" contenteditable="${mayEditLP? 'true':'false'}"
            data-link="${escapeHtml(r.link)}" data-crew="${r.crewIndex}" data-field="crewLPName"
            title="${mayEditLP? 'Edit LP name':'View only'}">${escapeHtml(r.lpName)}</div>
        </div>
      </td>`;

    const alpCell = `
      <td>
        <div class="cell-inner">
          <div class="editable" contenteditable="${mayEditALP? 'true':'false'}"
            data-link="${escapeHtml(r.link)}" data-crew="${r.crewIndex}" data-field="crewALPName"
            title="${mayEditALP? 'Edit ALP name':'View only'}">${escapeHtml(r.alpName)}</div>
        </div>
      </td>`;

    const trainCell = `<td class="train-cell"><div class="dep-pill">${escapeHtml(r.depTime||'')}</div><div class="cell-inner">${trainInner}</div></td>`;
    const depCell = `<td><div class="cell-inner">${escapeHtml(r.depTime||'')}</div></td>`;
    const linkCell = `<td><div class="cell-inner">${linkLabel} ${ownerTag}</div></td>`;

    tr.innerHTML = `${lpCell}${alpCell}${trainCell}${depCell}${linkCell}`;
    dutyTable.appendChild(tr);
  });

  document.querySelectorAll('.editable').forEach(el=>{
    if(el.__bound) return;
    el.__bound = true;

    el.addEventListener('focus', (ev)=>{
      if(el.getAttribute('contenteditable') !== 'true'){ el.blur(); return; }
      const txt = el.textContent.trim();
      el.dataset._orig = txt;
      placeCaretAtEnd(el);
    });

    el.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Escape'){ if(el.dataset._orig){ el.textContent = el.dataset._orig; el.blur(); } }
      else if(ev.key === 'Enter'){ ev.preventDefault(); el.blur(); }
    });

    el.addEventListener('blur', async (ev)=>{
      if(el.getAttribute('contenteditable') !== 'true'){ await renderCombinedDuties(); return; }
      await onEditableCommit(ev);
    });
  });

  setTimeout(setTableWrapPaddingAndHeader, 20);
}

/* ---------- commit edits ---------- */
async function onEditableCommit(e){
  const el = e.currentTarget;
  if(!el) return;

  const linkId = el.dataset.link;
  const crewIndex = Number(el.dataset.crew);
  const field = el.dataset.field;
  const newVal = sanitizeName(el.textContent);

  const userUid = (currentUser && currentUser.uid) ? currentUser.uid : (loadLocalUser()?.uid || createLocalUser().uid);
  const userReadable = (currentUser && (currentUser.email || currentUser.displayName)) || userUid;

  if(!localEdits[linkId]) localEdits[linkId] = {};
  if(!localEdits[linkId][crewIndex]) localEdits[linkId][crewIndex] = {};

  localEdits[linkId][crewIndex] = normalizeToRevisions(localEdits[linkId][crewIndex]);

  const effectiveFrom = dateOnlyISO(selectedDate);

  if(!newVal){
    const revs = localEdits[linkId][crewIndex]._revisions || {};
    if(revs[effectiveFrom] && revs[effectiveFrom][field]) delete revs[effectiveFrom][field];
    if(revs[effectiveFrom]){
      const remaining = Object.keys(revs[effectiveFrom]).filter(k => !k.startsWith('_'));
      if(remaining.length === 0) delete revs[effectiveFrom];
    }
    if(Object.keys(revs || {}).length === 0){
      delete localEdits[linkId][crewIndex];
      if(Object.keys(localEdits[linkId]||{}).length === 0) delete localEdits[linkId];
    } else {
      localEdits[linkId][crewIndex]._revisions = revs;
    }
    saveLocalEdits();
    showToast('Cleared locally');

    if(firebaseDb){
      try{
        const revPath = `/edits/${linkId}/${crewIndex}/_revisions/${effectiveFrom}/${field}`;
        scheduleFirebaseUpdate(revPath, null);
        showToast('Cleared (pending sync)');
      }catch(err){ console.error('Firebase clear schedule failed', err); showToast('Firebase clear failed'); }
    }
    await renderCombinedDuties();
    return;
  }

  const revs = localEdits[linkId][crewIndex]._revisions || {};
  revs[effectiveFrom] = revs[effectiveFrom] || {};
  revs[effectiveFrom][field] = newVal;
  revs[effectiveFrom]['_updatedBy'] = userUid;
  revs[effectiveFrom]['_updatedByName'] = userReadable;
  revs[effectiveFrom]['_updatedAt'] = new Date().toISOString();

  localEdits[linkId][crewIndex]['_revisions'] = revs;
  localEdits[linkId][crewIndex]['_updatedBy'] = userUid;
  localEdits[linkId][crewIndex]['_updatedByName'] = userReadable;
  localEdits[linkId][crewIndex]['_updatedAt'] = new Date().toISOString();

  saveLocalEdits();
  showToast('Saved locally');

  if(firebaseDb){
    try{
      const revPath = `/edits/${linkId}/${crewIndex}/_revisions/${effectiveFrom}`;
      scheduleFirebaseUpdate(revPath, Object.assign({}, revs[effectiveFrom]));
      const metaPath = `/edits/${linkId}/${crewIndex}`;
      scheduleFirebaseUpdate(metaPath, {_updatedBy: userUid, _updatedByName: userReadable, _updatedAt: new Date().toISOString()});
      showToast('Sync scheduled');
    }catch(err){ console.error('Firebase push schedule failed', err); showToast('Firebase sync failed'); }
  }

  await renderCombinedDuties();
}

/* ---------- debounced firebase writes ---------- */
function scheduleFirebaseUpdate(path, value){
  if(!firebaseDb) return;
  if(writeDebounce[path]) clearTimeout(writeDebounce[path].t);
  writeDebounce[path] = writeDebounce[path] || {};
  writeDebounce[path].v = value;
  writeDebounce[path].t = setTimeout(async ()=>{
    try{
      const payload = writeDebounce[path].v;
      if(payload === null) await firebaseDb.ref(path).set(null);
      else await firebaseDb.ref(path).update(payload);
    }catch(err){
      console.error('Debounced firebase write failed', path, err);
    } finally {
      delete writeDebounce[path];
    }
  }, WRITE_DEBOUNCE_MS);
}

/* ---------- admin sign-in & detection ---------- */
if(adminSignInBtn){
  adminSignInBtn.addEventListener('click', async ()=>{
    if(!firebaseAuth){ alert('Firebase not initialized.'); return; }
    const choice = confirm('Use existing admin account to sign in? OK = Sign in, Cancel = Sign out');
    if(!choice){
      try { await firebaseAuth.signOut(); showToast('Signed out'); currentUser = loadLocalUser() || createLocalUser(); await detectAdmin(); await renderCombinedDuties(); updateLoginStatusUI(); } catch(e){ console.warn(e); alert('Sign-out failed'); }
      return;
    }
    const email = prompt('Admin email:'); if(!email) return;
    const pwd = prompt('Password:'); if(!pwd) return;
    try {
      const cred = await firebaseAuth.signInWithEmailAndPassword(email, pwd);
      const fbUser = firebaseAuth.currentUser || (cred && cred.user);
      if(fbUser){
        currentUser = { uid: fbUser.uid, displayName: fbUser.displayName || fbUser.email || fbUser.uid, email: fbUser.email || null, anon: !!fbUser.isAnonymous };
        saveLocalUser(currentUser);
      }
      showToast('Signed in');
      await detectAdmin();
      await renderCombinedDuties();
      updateLoginStatusUI();
    } catch (err){
      alert('Sign-in failed: ' + (err.message || err));
    }
  });
}

async function detectAdmin(){
  currentUser = currentUser || loadLocalUser() || createLocalUser();
  isAdmin = false;
  try{
    const ADMIN_UIDS = [];
    if(ADMIN_UIDS.includes(currentUser.uid)) isAdmin = true;
    if(firebaseDb && currentUser && currentUser.uid){
      const snap = await firebaseDb.ref(`/meta/admins/${currentUser.uid}`).once('value');
      if(snap.exists() && snap.val() === true) isAdmin = true;
    }
  }catch(e){ console.warn('admin detect err', e); }
  updateLoginStatusUI();
}
function updateLoginStatusUI(){
  const u = currentUser || loadLocalUser();
  if(!u){ loginStatus.textContent = ''; adminSignInBtn.style.display = 'inline-block'; return; }
  loginStatus.textContent = isAdmin ? `Admin â€” editing enabled (${u.email || u.displayName})` : '';
  adminSignInBtn.style.display = 'inline-block';
}

/* ---------- visibility / online handlers ---------- */
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible' && firebaseDb){
    firebaseDb.ref('/edits').once('value').then(snap=>{
      latestFbEdits = snap.val() || {};
      reconcileLocalWithFirebase(latestFbEdits);
      renderCombinedDuties();
    }).catch(()=>{});
  }
});
window.addEventListener('online', ()=>{
  if(firebaseDb){
    attachRealtimeEditsListener();
    firebaseDb.ref('/edits').once('value').then(snap=>{
      latestFbEdits = snap.val() || {};
      reconcileLocalWithFirebase(latestFbEdits);
      renderCombinedDuties();
    }).catch(()=>{});
  }
});

/* ---------- init firebase & app ---------- */
try {
  firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
  firebaseAuth = firebase.auth();
  firebaseDb = firebase.database();
  if (firebaseAuth && firebase.auth && firebase.auth.Auth && firebase.auth.Auth.Persistence) {
    firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
  }
  firebaseAuth.onAuthStateChanged(async (user) => {
    if (user){
      currentUser = { uid: user.uid, displayName: user.displayName || user.email || user.uid, email: user.email || null, anon: user.isAnonymous || false };
    } else {
      currentUser = loadLocalUser() || createLocalUser();
    }
    await detectAdmin();
    updateLoginStatusUI();
    await renderCombinedDuties();
  });
} catch(e){
  console.warn('Firebase init error', e);
  currentUser = loadLocalUser() || createLocalUser();
  updateLoginStatusUI();
}

/* ---------- app start ---------- */
async function init(){
  setSelectedDate(new Date());
  currentUser = loadLocalUser() || createLocalUser();
  saveLocalUser(currentUser);
  localEdits = loadLocalEdits();
  await loadAllLinks();
  attachRealtimeEditsListener();
  startPollingFallback();
  window.addEventListener('resize', () => setTimeout(setTableWrapPaddingAndHeader, 60));
  window.addEventListener('orientationchange', () => setTimeout(setTableWrapPaddingAndHeader, 140));
  if(document.fonts && document.fonts.ready) document.fonts.ready.then(() => setTimeout(setTableWrapPaddingAndHeader, 80));
  updateLoginStatusUI();
}
document.addEventListener('DOMContentLoaded', init);

/* Service worker registration */
if('serviceWorker' in navigator){
  window.addEventListener('load', async () => {
    try {
      await navigator.serviceWorker.register('/daily-duty-list/service-worker.js');
      console.log('Service Worker registered');
    } catch (err) {
      console.warn('Service Worker registration failed:', err);
    }
  });
}

/* Install prompt handling */
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (installBtn) {
    installBtn.style.display = 'inline-flex';
    installBtn.addEventListener('click', async () => {
      installBtn.style.display = 'none';
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt = null;
    });
  }
});
window.addEventListener('appinstalled', () => {
  if(installBtn) installBtn.style.display = 'none';
});
/* ---------- End ---------- */

/* Diagnostics to run in Console after load:
   const uniq = Array.from(new Set((allCrewData||[]).map(x=>x.linkId)));
   console.table(uniq.map(id => ({ linkId: id, raw: (allCrewData.find(x=>x.linkId===id)||{}).linkIdRaw, mapped: getShortLinkLabel(id) })));
*/
</script>
</body>
</html>
