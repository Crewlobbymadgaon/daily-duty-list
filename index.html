<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>LP/ALP Duty Viewer - Combined Links</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    select, input[type="date"] { padding: 5px; margin-bottom: 10px; }
    .rest { background-color: #ffe0e0; }
    #dateHeading { font-size: 18px; margin-bottom: 10px; font-weight: bold; }
    .controls { margin-bottom: 15px; }
      
  </style>
</head>
<body>
  <body class="bg-gray-50 text-gray-900">

<header style="
  background: linear-gradient(90deg, #2563eb, #4f46e5);
  color: white;
  padding: 1.5rem;
  box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
  border-radius: 0 0 12px 12px;
  width: 100%;
  text-align: center;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
">
  <!-- Heading -->
  <h1 style="font-size: clamp(1.8rem, 5vw, 2.5rem); font-weight: 700; margin: 0 0 0.3rem;">
    Combined Crew Lobby Madgaon
  </h1>
  <p style="font-size: clamp(1.2rem, 4vw, 1.6rem); opacity: 0.9; margin: 0 0 1rem;">
    Crew Duty List
  </p>

  <!-- Date Display + Calendar Icon -->
  <div style="
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    font-size: 1.2rem;
    font-weight: 600;
    background: rgba(255,255,255,0.15);
    padding: 8px 14px;
    border-radius: 8px;
    border: 1.5px solid #a5b4fc;
    width: fit-content;
    margin: 0 auto;
  ">
    <span id="dateDisplay">Loading...</span>
    <label for="datePicker" style="cursor: pointer;">
      <svg xmlns="http://www.w3.org/2000/svg" style="width: 28px; height: 28px; fill: white;" viewBox="0 0 24 24">
        <path d="M7 10h5v5H7v-5zm-5 9V7a2 2 0 0 1 2-2h1V3h2v2h6V3h2v2h1a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm2 0h14V8H4v11z"/>
      </svg>
    </label>
    <input type="date" id="datePicker" style="display: none;" />
  </div>
</header>



  <table>
    <thead>
      <tr>
        <th>LP ID</th>
        <th>ALP ID</th>
        <th>Train No</th>
        <th>Dep Time</th>
        
      </tr>
    </thead>
    <tbody id="dutyTable"></tbody>
  </table>
<script>
const linkFiles = [
  'link1.json', 'link2.json', 'link3.json', 'link4.json',
  'rnlink1.json', 'rnlink2.json', 'rnlink3.json',
  'ollink1.json', 'sllink1.json'
];

let allCrewData = [];

// ----------------------
// DATE PICKER + HEADER
// ----------------------
const datePicker = document.getElementById("datePicker");
const dateDisplay = document.getElementById("dateDisplay");
const calendarIcon = document.getElementById("calendarIcon");

function formatDateDisplay(date) {
  const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

function setDate(date) {
  datePicker.valueAsDate = date;
  dateDisplay.textContent = formatDateDisplay(date);
  renderTableCombined();
}

// Open date picker from icon
calendarIcon.addEventListener("click", () => datePicker.showPicker());

// On date change
datePicker.addEventListener("change", () => {
  const selected = datePicker.valueAsDate || new Date();
  setDate(selected);
});

// ----------------------
// LOAD CREW DATA
// ----------------------
Promise.all(linkFiles.map(file =>
  fetch(file).then(res => {
    if (!res.ok) throw new Error(`Failed to load ${file}`);
    return res.json();
  })
)).then(allLinksData => {
  allCrewData = [];
  allLinksData.forEach(linkData => {
    const linkId = linkData.linkId || 0;
    const lastUpdatedDate = new Date(linkData.lastUpdated);
    const currentCrewIndex = linkData.currentCrewIndex || 0;

    const crewWithExtras = (linkData.crew || []).map((crewMember, index) => ({
      ...crewMember,
      linkId,
      lastUpdatedDate,
      currentCrewIndex,
      crewIndex: index
    }));

    allCrewData.push(...crewWithExtras);
  });

  renderTableCombined();
}).catch(err => {
  console.error('Error loading JSON files:', err);
  document.getElementById('dutyTable').innerHTML =
    `<tr><td colspan="5" style="color:red;">Error loading data</td></tr>`;
});

// ----------------------
// RENDER TABLE
// ----------------------
function renderTableCombined() {
  if (!allCrewData.length) return;

  const selectedDate = getSelectedDate();

  // Group crew by linkId
  const crewsByLink = {};
  allCrewData.forEach(crew => {
    if (!crewsByLink[crew.linkId]) crewsByLink[crew.linkId] = [];
    crewsByLink[crew.linkId].push(crew);
  });

  const dutyRows = [];

  Object.values(crewsByLink).forEach(crewList => {
    if (!crewList.length) return;

    const { linkId, lastUpdatedDate } = crewList[0];
    const diffMs = selectedDate.getTime() - lastUpdatedDate.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const weeksPassed = Math.floor(diffDays / 7);

    const dutiesPerRow = crewList.map(crew => crew.duties);
    const dayName = selectedDate.toLocaleString('en-US', { weekday: 'long' });

    for (let rowIndex = 0; rowIndex < crewList.length; rowIndex++) {
      const crewIndex = (rowIndex - weeksPassed + crewList.length) % crewList.length;
      const crew = crewList[crewIndex];
      const dutyForRow = dutiesPerRow[rowIndex][dayName] || '';

      let trainNo = '';
      let depTime = '';

      if (typeof dutyForRow === 'object' && dutyForRow.outgoing) {
        trainNo = dutyForRow.incoming?.trim()
          ? `${dutyForRow.outgoing}/${dutyForRow.incoming}`
          : dutyForRow.outgoing;
        depTime = dutyForRow.depTime || '';
      } else if (typeof dutyForRow === 'string') {
        trainNo = dutyForRow.toUpperCase() === 'REST' ? 'REST' : dutyForRow;
      }

      dutyRows.push({
        crewLPId: crew.crewLPId,
        crewALPId: crew.crewALPId,
        trainNo,
        depTime,
        linkNumber: linkId,
        isRest: trainNo.toUpperCase() === 'REST',
      });
    }
  });

  // Filter + Sort
  const filteredRows = dutyRows.filter(row =>
    row.trainNo && row.trainNo.trim() !== '' && row.trainNo.toUpperCase() !== 'REST'
  );

  filteredRows.sort((a, b) => {
    if (a.depTime && b.depTime) return timeStringToMinutes(a.depTime) - timeStringToMinutes(b.depTime);
    if (a.depTime && !b.depTime) return -1;
    if (!a.depTime && b.depTime) return 1;
    return 0;
  });

  // Render table
  const tbody = document.getElementById('dutyTable');
  tbody.innerHTML = '';
  filteredRows.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.crewLPId}</td>
      <td>${row.crewALPId}</td>
      <td>${row.trainNo}</td>
      <td>${row.depTime || ''}</td>
      <td>${row.linkNumber}</td>
    `;
    tbody.appendChild(tr);
  });
}

function timeStringToMinutes(timeStr) {
  if (!timeStr) return Infinity;
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
}

function getSelectedDate() {
  return datePicker.valueAsDate || new Date();
}

// ----------------------
// INIT
// ----------------------
setDate(new Date());
</script>
</body>
</html>
