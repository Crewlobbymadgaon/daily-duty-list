<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LP/ALP Duty List â€” Madgaon Lobby</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f7fb; --card:#fff; --muted:#6b7280; --accent:#0f172a; --accent-2:#2563eb;
  --radius:12px; --divider:#1f6feb; --border:#cdd4e1;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--accent);-webkit-font-smoothing:antialiased}
.wrap{max-width:1100px;margin:0 auto;padding:14px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 24px rgba(15,23,42,0.06);overflow:hidden}
.headerArea{position:sticky; top:0;background:var(--card);padding:14px 16px;border-bottom:1px solid rgba(0,0,0,0.04);z-index:60;display:flex;flex-direction:column;align-items:center;gap:6px;}
.headerArea h1{margin:0;font-size:1.25rem;font-weight:700;text-align:center}
.headerArea .sub{font-size:0.9rem;color:var(--muted);text-align:center}
.headerArea #dateHeading{font-weight:600;color:var(--accent-2);text-align:center}
.headerArea #loginStatus{font-size:0.78rem;color:var(--muted);margin-top:6px}
.headerArea #notice{font-size:0.78rem;color:#6b7280;margin-top:4px}
.controls{position:sticky;top:0;background:var(--card);z-index:55;display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;border-bottom:1px solid rgba(0,0,0,0.03)}
.nav-btn{background:transparent;border:1px solid rgba(15,23,42,0.06);width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.date-icon-btn{display:inline-flex;align-items:center;justify-content:center;background:var(--accent-2);color:#fff;border:none;border-radius:8px;min-width:44px;height:36px;padding:0 10px;cursor:pointer}
input[type="date"].native-date{position:absolute;left:-9999px}
.tableWrap{max-height:calc(100vh - 112px);overflow:auto;border-radius:0;background:#fff;padding:6px;position:relative}
table{width:100%;border-collapse:collapse;min-width:640px;table-layout:fixed;border:1px solid var(--border)}
thead th{background:var(--card);padding:10px 12px;text-align:center;color:var(--muted);font-weight:700;border-bottom:1px solid var(--border);border-top:1px solid rgba(0,0,0,0.04);position:sticky;z-index:70;top:0;box-sizing:border-box}
tbody td{padding:10px 12px;border:1px solid var(--border);font-size:0.95rem;color:var(--accent);vertical-align:middle;text-align:center;overflow:visible;word-break:break-word;overflow-wrap:anywhere}
tbody tr:nth-child(odd){background:#fbfdff}
.no-data{text-align:center;color:var(--muted);padding:14px}
thead th:nth-child(1), td:nth-child(1){width:34%}
thead th:nth-child(2), td:nth-child(2){width:34%}
thead th:nth-child(3), td:nth-child(3){width:18%}
thead th:nth-child(4), td:nth-child(4){width:6%}
thead th:nth-child(5), td:nth-child(5){width:8%}
.cell-center{display:flex;align-items:center;justify-content:center;min-height:44px}
.train-stack{display:inline-flex;flex-direction:column;align-items:center;gap:4px;padding:4px 6px;max-width:100%;box-sizing:border-box}
.train-top,.train-bottom{font-weight:400;font-size:0.90rem;line-height:1;display:inline-block;text-align:center;white-space:normal;overflow-wrap:anywhere;word-break:break-word;max-width:100%}
.train-divider{ width:90%; height:2px; background:var(--divider); border-radius:2px; margin:0; }
.nowrap{ white-space:nowrap; display:inline-block; }
@media (min-width:900px){ .train-divider{ width:100%; max-width:180px } }
@media (max-width:640px){
  table{min-width:0;table-layout:auto}
  thead th:nth-child(4),thead th:nth-child(5),tbody td:nth-child(4),tbody td:nth-child(5){display:none}
  thead th,tbody td{padding:8px}
  .train-top,.train-bottom{font-size:0.86rem}
  .train-divider{height:1.5px; width:85%}
}

/* editing UI (modal) */
.edit-btn{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:6px 8px;border-radius:8px;cursor:pointer}
.ownerTag{font-size:0.7rem;color:#fff;background:#2563eb;padding:4px 6px;border-radius:6px;display:inline-block;margin-left:6px}
.toast{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .18s;z-index:300}
.toast.show{opacity:1;transform:translateY(0)}
/* modal */
.modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.32);z-index:400}
.modal{width:360px;max-width:94%;background:#fff;padding:16px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.18)}
.modal h3{margin:0 0 8px;font-size:1.05rem}
.modal label{display:block;margin-top:10px;color:var(--muted);font-size:0.85rem}
.modal input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc;margin-top:6px}
.row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.btn{background:var(--accent-2);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
.btn.secondary{background:#e6eefc;color:var(--accent)}
.small{font-size:0.85rem;color:var(--muted)}
/* small responsive tweak */
@media (max-width:420px){ .modal{padding:12px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="headerArea" role="banner" aria-label="Header">
        <h1>LP/ALP Duty List</h1>
        <div class="sub">Madgaon Lobby</div>
        <div id="dateHeading">Loading dateâ€¦</div>
        <div id="loginStatus" aria-live="polite"></div>
        <div id="notice">Admins can edit names â€” employees can only view.</div>
      </div>

      <div class="controls" role="toolbar" aria-label="Date controls">
        <button id="prevDay" class="nav-btn" title="Previous day">â—€</button>
        <button id="dateBtn" class="date-icon-btn" title="Pick a date">ðŸ“…</button>
        <input id="datePicker" class="native-date" type="date" />
        <button id="nextDay" class="nav-btn" title="Next day">â–¶</button>
      </div>

      <div class="tableWrap" aria-live="polite">
        <table id="mainTable" aria-describedby="dateHeading">
          <thead>
            <tr>
              <th>Name of LP</th>
              <th>Name of ALP</th>
              <th>Train No</th>
              <th>Dep</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="dutyTable">
            <tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <button id="adminSignInBtn" title="Admin sign-in" style="position:fixed;top:10px;right:10px;z-index:350" class="btn">Admin</button>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Edit modal -->
  <div id="editModal" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <h3>Edit names</h3>
      <div class="small">Link: <span id="modalLink"></span> â€” crew index: <span id="modalCrew"></span></div>
      <label for="modalLP">LP name</label>
      <input id="modalLP" type="text" />
      <label for="modalALP">ALP name</label>
      <input id="modalALP" type="text" />
      <div class="row">
        <button id="modalCancel" class="btn secondary">Cancel</button>
        <button id="modalSave" class="btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Sign-in modal -->
  <div id="signModal" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <h3>Admin sign in</h3>
      <div class="small">Use your admin email and password</div>
      <label for="siEmail">Email</label>
      <input id="siEmail" type="email" autocomplete="username" />
      <label for="siPass">Password</label>
      <input id="siPass" type="password" autocomplete="current-password" />
      <div class="row">
        <button id="siCancel" class="btn secondary">Cancel</button>
        <button id="siDo" class="btn">Sign in</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat (keep these unless you migrate to modular SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ------------------ Configuration ------------------
   Injected Firebase config (from user)
*/
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyA39vWi_90CUyj0davz4XAXqMey1aNM6FU",
  authDomain: "crewdutytable.firebaseapp.com",
  databaseURL: "https://crewdutytable-default-rtdb.firebaseio.com",
  projectId: "crewdutytable",
  storageBucket: "crewdutytable.firebasestorage.app",
  messagingSenderId: "190634478615",
  appId: "1:190634478615:web:28e998325f69fb8bf36052"
};
/* Place your link*.json files in same folder as this HTML */
const linkFiles = [
  'link1.json','link2.json','link3.json','link4.json',
  'rnlink1.json','rnlink2.json','rnlink3.json',
  'ollink1.json','sllink1.json'
];
const LS_KEY = 'lp_alp_edits_owner_v2';

/* ------------------ State ------------------ */
let localEdits = loadLocalEdits();
let allCrewData = [];
let selectedDate = new Date();
let firebaseApp = null, firebaseAuth = null, firebaseDb = null;
let currentUser = null, isAdmin = false;

/* DOM refs */
const dutyTable = document.getElementById('dutyTable');
const dateBtn = document.getElementById('dateBtn');
const datePicker = document.getElementById('datePicker');
const prevBtn = document.getElementById('prevDay');
const nextBtn = document.getElementById('nextDay');
const dateHeading = document.getElementById('dateHeading');
const toast = document.getElementById('toast');
const adminSignInBtn = document.getElementById('adminSignInBtn');

/* modals */
const editModal = document.getElementById('editModal');
const modalLink = document.getElementById('modalLink');
const modalCrew = document.getElementById('modalCrew');
const modalLP = document.getElementById('modalLP');
const modalALP = document.getElementById('modalALP');
const modalCancel = document.getElementById('modalCancel');
const modalSave = document.getElementById('modalSave');

const signModal = document.getElementById('signModal');
const siEmail = document.getElementById('siEmail');
const siPass = document.getElementById('siPass');
const siCancel = document.getElementById('siCancel');
const siDo = document.getElementById('siDo');

/* helpers */
function showToast(msg, t=1800){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(toast._t); toast._t=setTimeout(()=>toast.classList.remove('show'), t); }
function loadLocalEdits(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(e){ return {}; } }
function saveLocalEdits(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(localEdits)); }catch(e){} }
function saveLocalUser(u){ try{ localStorage.setItem('lp_user_v_owner', JSON.stringify(u)); }catch(e){} }
function loadLocalUser(){ try{ return JSON.parse(localStorage.getItem('lp_user_v_owner')||'null'); }catch(e){ return null; } }
function createLocalUser(){ const uid = 'local-'+Math.random().toString(36).slice(2,9); const u = { uid, displayName: `Viewer-${uid.slice(-4)}`, local:true }; saveLocalUser(u); return u; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }
function formatTrainToken(token){ if(!token) return ''; const cleaned = token.toString().trim(); if(/^\d{5}$/.test(cleaned)){ return `<span class="nowrap">${escapeHtml(cleaned)}</span>`; } return escapeHtml(cleaned).replace(/\//g,'<wbr>/'); }

/* mapping helper */
function getShortLinkLabel(linkId) {
  if (!linkId) return '';
  const id = String(linkId).toLowerCase();
  if (id.startsWith('link')) { const num = id.replace(/\D/g, ''); return `MAO${num}`; }
  if (id.startsWith('rnlink')) { const num = id.replace(/\D/g, ''); return `RN${num}`; }
  if (id.startsWith('ollink')) { const num = id.replace(/\D/g, ''); return `OL${num}`; }
  if (id.startsWith('sllink')) { const num = id.replace(/\D/g, ''); return `SL${num}`; }
  const digits = id.match(/\d+/);
  if(digits) return `L${digits[0]}`;
  return String(linkId).toUpperCase();
}

/* layout helpers (kept simple) */
function setSelectedDate(d){ selectedDate = d||new Date(); const yyyy=selectedDate.getFullYear(), mm=String(selectedDate.getMonth()+1).padStart(2,'0'), dd=String(selectedDate.getDate()).padStart(2,'0'); datePicker.value = `${yyyy}-${mm}-${dd}`; dateHeading.textContent = `${selectedDate.toLocaleString('en-US',{weekday:'long'})}, ${selectedDate.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})}`; }
dateBtn.addEventListener('click', ()=>{ datePicker.focus(); datePicker.click(); });
datePicker.addEventListener('change', ()=>{ selectedDate = datePicker.value ? new Date(datePicker.value+'T00:00:00') : new Date(); setSelectedDate(selectedDate); renderCombinedDuties(); });
prevBtn.addEventListener('click', ()=> changeDate(-1));
nextBtn.addEventListener('click', ()=> changeDate(1));
function changeDate(offset){ const d=new Date(selectedDate.getTime()); d.setDate(d.getDate()+offset); setSelectedDate(d); renderCombinedDuties(); }

/* ------------------ Load link JSONs ------------------ */
async function loadAllLinks(){
  dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">Loading dataâ€¦</td></tr>`;
  const fetches = linkFiles.map(async (f, idx) => {
    try {
      const r = await fetch(f, {cache:'no-cache'});
      if(!r.ok) return { __error:true, file:f, status:r.status };
      const json = await r.json().catch(()=> ({ __error:true, file:f, parseErr:true }));
      return json;
    } catch(e){ return { __error:true, file:f, err:e && e.message }; }
  });
  const results = await Promise.all(fetches);
  allCrewData = [];
  const anySuccess = results.some(r => r && !r.__error);
  if(!anySuccess){
    dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">Failed to load link files â€” check they are in same folder as index.html</td></tr>`;
    return;
  }
  results.forEach((linkData, idx)=>{
    if(!linkData || linkData.__error) return;
    const linkId = linkData.linkId ?? (`file#${idx+1}`);
    const crew = Array.isArray(linkData.crew) ? linkData.crew : [];
    crew.forEach((c, i) => allCrewData.push({...c, linkId, crewIndex:i}));
  });
  await renderCombinedDuties();
}

/* ------------------ Render rows (read-only for viewers) ------------------ */
async function renderCombinedDuties(){
  if(!allCrewData || allCrewData.length===0){ dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No data available</td></tr>`; return; }

  // load firebase edits if DB available
  let fbEdits = {};
  if(firebaseDb){
    try{ const snap = await firebaseDb.ref('/edits').once('value'); fbEdits = snap.val() || {}; }catch(e){ fbEdits = {}; }
  }

  // group by linkId and then process duties for selected weekday
  const weekday = selectedDate.toLocaleString('en-US',{weekday:'long'});
  // arrange rows: for each crew item, decide displayed lp & alp (merged with edits)
  const rows = [];
  allCrewData.forEach(cd=>{
    const link = cd.linkId;
    const crewIdx = cd.crewIndex;
    const duties = cd.duties || {};
    const dutyForDay = duties[weekday] ?? '';
    let outgoing='', incoming='', depTime='';
    if(dutyForDay && typeof dutyForDay === 'object'){
      outgoing = (dutyForDay.outgoing||'').toString().trim();
      incoming = (dutyForDay.incoming||'').toString().trim();
      depTime = (dutyForDay.depTime||'').toString().trim();
    } else if(typeof dutyForDay === 'string') outgoing = dutyForDay.trim();
    const combined = (incoming ? `${outgoing}/${incoming}` : outgoing).toUpperCase();
    if(!combined || combined === 'REST') return;
    // pick lp & alp from firebase edits, then local edits, else fallback label
    const fb = (fbEdits[link] && fbEdits[link][crewIdx]) || {};
    const local = (localEdits[link] && localEdits[link][crewIdx]) || {};
    const lpName = (fb.crewLPName && fb.crewLPName.trim()) || (local.crewLPName && local.crewLPName.trim()) || getShortLinkLabel(link);
    const alpName = (fb.crewALPName && fb.crewALPName.trim()) || (local.crewALPName && local.crewALPName.trim()) || getShortLinkLabel(link);
    const ownerName = (fb._updatedByName || local._updatedByName) || null;
    rows.push({ link, crewIdx, lpName, alpName, depTime, outgoing, incoming, ownerName });
  });

  // sort by depTime if numeric hh:mm else keep order
  function tmin(t){ if(!t) return Infinity; const m=t.match(/^(\d{1,2}):(\d{2})$/); return m ? (+m[1])*60 + (+m[2]) : Infinity; }
  rows.sort((a,b)=> tmin(a.depTime) - tmin(b.depTime));

  if(rows.length===0){ dutyTable.innerHTML = `<tr><td colspan="5" class="no-data">No duties for ${weekday}</td></tr>`; return; }
  dutyTable.innerHTML = '';

  rows.forEach(r=>{
    const outHtml = formatTrainToken(r.outgoing || '');
    const incHtml = formatTrainToken(r.incoming || '');
    const trainHtml = incHtml ? `<div class="cell-center"><div class="train-stack"><div class="train-top">${outHtml}</div><div class="train-divider" aria-hidden="true"></div><div class="train-bottom">${incHtml}</div></div></div>` : `<div class="cell-center"><div class="train-stack"><div class="train-top">${outHtml}</div></div></div>`;
    const tr = document.createElement('tr');

    // actions cell: show edit button only if admin
    const actions = isAdmin ? `<button class="edit-btn" data-link="${escapeHtml(r.link)}" data-crew="${r.crewIdx}">âœŽ Edit</button> ${r.ownerName ? `<span class="ownerTag">${escapeHtml(r.ownerName)}</span>` : ''}` : `<div class="small">${escapeHtml(getShortLinkLabel(r.link))}</div>`;

    tr.innerHTML = `
      <td><div class="cell-center"><div style="width:100%;text-align:center">${escapeHtml(r.lpName)}</div></div></td>
      <td><div class="cell-center"><div style="width:100%;text-align:center">${escapeHtml(r.alpName)}</div></div></td>
      <td>${trainHtml}</td>
      <td><div class="cell-center">${escapeHtml(r.depTime||'')}</div></td>
      <td><div class="cell-center">${actions}</div></td>
    `;
    dutyTable.appendChild(tr);
  });

  // attach edit handlers only for admin-visible edit buttons
  if(isAdmin){
    document.querySelectorAll('.edit-btn').forEach(btn=>{
      if(btn.__bound) return;
      btn.__bound = true;
      btn.addEventListener('click', (ev)=>{
        const link = btn.dataset.link;
        const crew = Number(btn.dataset.crew);
        openEditModal(link, crew);
      });
    });
  }
}

/* ------------------ Edit flow (modal) ------------------ */
function openEditModal(link, crewIndex){
  modalLink.textContent = getShortLinkLabel(link);
  modalCrew.textContent = crewIndex;
  // prefill current names from merged source
  const fbRef = firebaseDb ? firebaseDb.ref(`/edits/${link}/${crewIndex}`) : null;
  // compute current values from fb or local or default label
  let currentLP = '';
  let currentALP = '';
  if(firebaseDb){
    firebaseDb.ref(`/edits/${link}/${crewIndex}`).once('value').then(snap=>{
      const v = snap.val() || {};
      const local = (localEdits[link] && localEdits[link][crewIndex]) || {};
      currentLP = (v.crewLPName && v.crewLPName.trim()) || (local.crewLPName && local.crewLPName.trim()) || getShortLinkLabel(link);
      currentALP = (v.crewALPName && v.crewALPName.trim()) || (local.crewALPName && local.crewALPName.trim()) || getShortLinkLabel(link);
      modalLP.value = currentLP;
      modalALP.value = currentALP;
    }).catch(()=>{
      const local = (localEdits[link] && localEdits[link][crewIndex]) || {};
      modalLP.value = (local.crewLPName && local.crewLPName.trim()) || getShortLinkLabel(link);
      modalALP.value = (local.crewALPName && local.crewALPName.trim()) || getShortLinkLabel(link);
    });
  } else {
    const local = (localEdits[link] && localEdits[link][crewIndex]) || {};
    modalLP.value = (local.crewLPName && local.crewLPName.trim()) || getShortLinkLabel(link);
    modalALP.value = (local.crewALPName && local.crewALPName.trim()) || getShortLinkLabel(link);
  }

  // show modal
  editModal.style.display = 'flex';
  editModal.setAttribute('aria-hidden','false');
  // attach save handler (one-time)
  modalSave.onclick = async ()=>{
    const newLP = modalLP.value.trim();
    const newALP = modalALP.value.trim();
    await commitEdit(link, crewIndex, newLP, newALP);
    closeEditModal();
  };
  modalCancel.onclick = closeEditModal;
}
function closeEditModal(){
  editModal.style.display = 'none';
  editModal.setAttribute('aria-hidden','true');
}

/* commit to local and firebase (admin only) */
async function commitEdit(link, crewIndex, lp, alp){
  if(!isAdmin){ showToast('Not authorized'); return; }
  // update local cache
  if(!localEdits[link]) localEdits[link] = {};
  if(!localEdits[link][crewIndex]) localEdits[link][crewIndex] = {};
  localEdits[link][crewIndex].crewLPName = lp || null;
  localEdits[link][crewIndex].crewALPName = alp || null;
  localEdits[link][crewIndex]._updatedBy = currentUser && currentUser.uid;
  localEdits[link][crewIndex]._updatedByName = (currentUser && (currentUser.displayName || currentUser.email)) || (currentUser && currentUser.uid) || 'admin';
  localEdits[link][crewIndex]._updatedAt = new Date().toISOString();
  saveLocalEdits();
  showToast('Saved locally');

  // push to Firebase
  if(firebaseDb){
    const payload = {
      crewLPName: lp || null,
      crewALPName: alp || null,
      _updatedBy: localEdits[link][crewIndex]._updatedBy,
      _updatedByName: localEdits[link][crewIndex]._updatedByName,
      _updatedAt: localEdits[link][crewIndex]._updatedAt
    };
    try{
      await firebaseDb.ref(`/edits/${link}/${crewIndex}`).update(payload);
      showToast('Synced to Firebase');
    }catch(err){
      console.error('Firebase write failed', err);
      showToast('Firebase sync failed');
    }
  }
  await renderCombinedDuties();
}

/* ------------------ Admin sign-in flow (modal) ------------------ */
adminSignInBtn.addEventListener('click', ()=>{
  if(firebaseAuth && firebaseAuth.currentUser && isAdmin){
    // sign out
    firebaseAuth.signOut().then(()=>{ showToast('Signed out'); }).catch(()=>{ showToast('Sign-out failed'); });
    return;
  }
  // open sign modal
  signModal.style.display = 'flex';
  signModal.setAttribute('aria-hidden','false');
  siEmail.value=''; siPass.value='';
  siEmail.focus();
});
siCancel.addEventListener('click', ()=>{
  signModal.style.display = 'none';
  signModal.setAttribute('aria-hidden','true');
});
siDo.addEventListener('click', async ()=>{
  const e = siEmail.value && siEmail.value.trim();
  const p = siPass.value && siPass.value.trim();
  if(!e || !p){ alert('Enter email & password'); return; }
  try{
    const cred = await firebaseAuth.signInWithEmailAndPassword(e,p);
    const fbUser = firebaseAuth.currentUser || (cred && cred.user);
    if(fbUser){
      currentUser = { uid: fbUser.uid, displayName: fbUser.displayName || fbUser.email || fbUser.uid, email: fbUser.email || null, anon: fbUser.isAnonymous };
      saveLocalUser(currentUser);
      showToast('Signed in');
    }
    signModal.style.display = 'none';
    signModal.setAttribute('aria-hidden','true');
    await detectAdmin();
    await renderCombinedDuties();
  }catch(err){
    console.error('Sign-in failed', err);
    alert('Sign-in failed: ' + (err && err.message || 'unknown'));
  }
});

/* ------------------ Admin detection + UI updates ------------------ */
async function detectAdmin(){
  currentUser = currentUser || loadLocalUser() || createLocalUser();
  isAdmin = false;
  try{
    // optional override (leave empty) 
    const ADMIN_UIDS = [];
    if(ADMIN_UIDS.includes(currentUser.uid)) isAdmin = true;
    if(firebaseDb && currentUser && currentUser.uid){
      // check db /meta/admins/<uid> === true
      const snap = await firebaseDb.ref(`/meta/admins/${currentUser.uid}`).once('value');
      if(snap.exists() && snap.val() === true) isAdmin = true;
    }
  }catch(e){ console.warn('admin detect error', e); }
  updateLoginStatusUI();
}
function updateLoginStatusUI(){
  const loginStatus = document.getElementById('loginStatus');
  if(isAdmin){
    loginStatus.textContent = 'Admin â€” editing enabled';
    adminSignInBtn.textContent = 'Sign out';
  } else {
    // guest viewer
    const u = loadLocalUser();
    loginStatus.textContent = '';
    adminSignInBtn.textContent = 'Admin';
  }
}

/* ------------------ Init Firebase and app ------------------ */
try {
  firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
  firebaseAuth = firebase.auth();
  firebaseDb = firebase.database();
  // set persistence for auth
  if(firebaseAuth && firebase.auth && firebase.auth.Auth && firebase.auth.Auth.Persistence){
    firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
  }
  firebaseAuth.onAuthStateChanged(async (user) => {
    if(user){
      currentUser = { uid: user.uid, displayName: user.displayName || user.email || user.uid, email: user.email || null, anon: user.isAnonymous };
    } else {
      currentUser = loadLocalUser() || createLocalUser();
    }
    await detectAdmin();
    await loadAllLinks();
  });
} catch(e){
  console.warn('Firebase init error', e);
  currentUser = loadLocalUser() || createLocalUser();
  await loadAllLinks().catch(()=>{});
}

/* ------------------ bootstrap ------------------ */
async function init(){
  setSelectedDate(new Date());
  currentUser = loadLocalUser() || createLocalUser();
  saveLocalUser(currentUser);
  localEdits = loadLocalEdits();
  // if firebase already initialized via onAuthStateChanged it will call loadAllLinks; otherwise call explicitly:
  if(!firebaseAuth) await loadAllLinks();
  window.addEventListener('resize', ()=>{});
  // modal close on backdrop click
  editModal.addEventListener('click', (ev)=>{ if(ev.target === editModal) closeEditModal(); });
  signModal.addEventListener('click', (ev)=>{ if(ev.target === signModal){ signModal.style.display='none'; signModal.setAttribute('aria-hidden','true'); }});
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
